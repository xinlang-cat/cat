<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>项目信息</title>
    <link rel="stylesheet" type="text/css" media="screen" href="../../layui/css/layui.css">
    <link rel="stylesheet" type="text/css" media="screen" href="../item/css/newProjecy.css">
    <style>
        .layui-table td {
            position: initial;
        }

        .layui-textarea {
            min-height: 60px;
        }
    </style>
</head>

<body>
<div style="position: fixed;top: 0;width: 100%;height: 60px;background-color: white;z-index: 1;">
    <div style="position: absolute;right: 30px;top: 15px;">
        <button type="button" class="layui-btn layui-btn-sm" onclick="submit(1);">提交</button>
    </div>
</div>
<div class="layui-form" style="margin-top: 60px;">


    <table class="layui-table" lay-skin="nob" style="border-collapse: separate;">
        <colgroup>
            <col width="8%">
            <col width="3%">
            <col width="15%">
            <col width="28%">
            <col width="2%">
            <col width="5%">
            <col width="20">
            <col width="8%">
            <col width="3%">
            <col width="8%">
        </colgroup>
        <tbody>
        <tr style="height: 30px;">
            <td class="mainTd_0" rowspan="1" colspan="10"></td>
        </tr>
        <tr style="height: 22px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="8"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>
        <tr style="height: 33px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="2" colspan="2" style=""></td>
            <td class="mainTd_1" rowspan="1" colspan="4" style="text-align: center;">
                <div class="headline">
                    <span>变更内容</span>
                </div>
            </td>
            <td class="mainTd_1" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="1"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>
        <tr style="height: 25px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="6"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>
        <tr style="height: 25px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="8" style="border-bottom: 1px solid #dadcde;"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>
        <tr style="height: 30px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="8"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>
        <tr style="height: 24px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="8"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>
        <tr style="height: 40px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="6">
                <div class="contactWay">
                    <form id="form1">
                        <table class="layui-table">
                            <colgroup>
                                <col width="8%">
                                <col width="3%">
                                <col width="10%">
                                <col width="28%">
                                <col width="2%">
                                <col width="3%">
                                <col width="8%">
                                <col width="10%">
                                <col width="20">
                                <col width="8%">
                            </colgroup>
                            <thead>
                            </thead>
                            <tbody id="old">
                            </tbody>
                        </table>
                    </form>
                </div>
            </td>
            <td class="mainTd_1" rowspan="1" colspan="1"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>


        <tr style="height: 30px;">
            <td class="mainTd_0" rowspan="1" colspan="10"></td>
        </tr>
        <tr style="height: 22px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="8"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>
        <tr style="height: 33px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="2" colspan="2" style=""></td>
            <td class="mainTd_1" rowspan="1" colspan="4" style="text-align: center;">
                <div class="headline">
                    <span>变更说明</span>
                </div>
            </td>
            <td class="mainTd_1" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="1"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>
        <tr style="height: 25px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="6"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>
        <tr style="height: 25px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="8" style="border-bottom: 1px solid #dadcde;"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>
        <tr style="height: 30px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="8"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>
        <!--基本信息-->
        <form id="form">
            <tr style="height: 24px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="8"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>

            <tr style="height: 25px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="8"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>
            <tr style="height: 40px; ">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1">
                    <div class="field">
                        <span>变更原因</span>
                    </div>
                </td>
                <td class="mainTd_1 tdDorder" rowspan="1" colspan="5">
                    <div class="field">
                        <input type="hidden" name="type" id="type">
                        <input type="hidden" name="item_id" id="item_id">
                        <input type="hidden" name="status" id="status">
                        <input type="hidden" name="check_unit" id="check_unit">
                        <input type="hidden" name="manage_unit" id="manage_unit">
                        <textarea name="content" id="content" placeholder="请输入内容" class="layui-textarea"></textarea>
                    </div>
                </td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>
            <tr style="height: 24px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="8"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>
            <tr style="height: 40px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1">
                    <div class="field">
                        <button type="button" class="layui-btn" id="upload_accessory">
                            <i class="layui-icon">&#xe67c;</i>上传附件
                        </button>
                        <span style="color: #999;">只支持jpg格式的图片</span>
                    </div>
                </td>
                <td class="mainTd_1" rowspan="1" colspan="5">
                    <div class="field">
                        <label class="col-md-1 control-label">附件:</label>
                        <div class="col-md-11" id="accessory_files">

                        </div>
                    </div>
                </td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>
        </form>
        </tbody>
    </table>
</div>
</body>

<script type="text/javascript" src="../../js/libs/jquery-3.3.1.min.js"></script>
<script src="../../js/constant.js"></script>
<script type="text/javascript" src="../../js/jq.js"></script>
<script type="text/javascript" src="../../js/common.js"></script>
<script type="text/javascript" src="../../layui/layui.js"></script>
<script type="text/javascript" src="../list-layout/js/serializeJson.js"></script>
<script type="text/javascript" src='../list-layout/js/initSelectData.js'></script>
<script type="text/javascript" src='../item/js/updateProject.js'></script>
<script type="application/javascript" src="../../layui/xm-select.js"></script>
<script type="application/javascript" src="js/updateProjectVice.js"></script>
<script type="text/javascript" src='../../js/sendMessage.js'></script>
<script>
    layui.use(['form', 'layedit', 'laydate', 'element', 'jquery', 'upload'], function () {
        var form = layui.form,
            layer = layui.layer,
            element = layui.element,
            laydate = layui.laydate,
            upload = layui.upload,
            $ = layui.jquery;
        lay('.date').each(function () {
            laydate.render({
                elem: this
                , type: 'month'
                , range: true
                , trigger: 'click'
            });
        });
        upload.render({
            elem: '#upload_accessory' //绑定元素
            , accept: 'jpg'
            , multiple: true
            , url: domainName + '/zuul/api-f/albums'
            , allDone: function (obj) { //当文件全部被提交后，才触发
                layer.msg("上传成功");
            }
            , done: function (res, index, upload) {
                addImgHtml(res);

            }
        });


        //插入一张图片
        function addImgHtml(item) {
            var str = '';
            var val = item.name.substring(0, item.name.indexOf("."));
            if (val.length > 10) {
                val = val.substring(0, 8) + '...';
            }
            str = '<div onmouseover="showOrHideCloseBut(this)" onmouseout="showOrHideCloseBut(this)" style="float: left;position: relative;text-align: center;height: 250px;"><input type="hidden" name="accessory" value="' + item['id'] + '" >';
            str += '<img onclick="seeImg(\'' + item.url + '\')" src="' + item.url + '" title="' + item.name + '" style="width: 150px;margin: 15px 5px 0 5px;">';
            str += '<a class="close-a" href="#" style="position: absolute;right: 5px;top: 15px" onclick="deleteImg(this)"><i class="layui-icon" style="color: white;background-color: #1AA094;opacity:0.8;">&#x1006;</i></a>';
            str += '<p style="color: #aea9a9;">' + val + '</p></div>';
            $("#accessory_files").append(str);
            $(".close-a").hide();
        }


        //监听提交
        form.on('submit(submit)', function (data) {
            //layer.msg(JSON.stringify(data.field));
            submit();
            //return false;
        });

    });
    var h = $(window).height() - 50;
    var w = $(window).width() - 30;
    ;

    //移除一张图片
    function deleteImg(obj) {
        $(obj).parent('div').remove();
    }

    function seeImg(url) {
        var imgHtml = "<img src='" + url + "' />";
        layer.open({
            type: 1,
            maxmin: true,
            shadeClose: true,
            area: [w + 'px', h + 'px'],
            content: imgHtml, //捕获的元素，注意：最好该指定的元素要存放在body最外层，否则可能被其它的相对元素所影响
            cancel: function () {
                //layer.msg('捕获就是从页面已经存在的元素上，包裹layer的结构', { time: 5000, icon: 6 });
            }
        });
    }

    //显示隐藏图片删除按钮
    function showOrHideCloseBut(obj) {
        var eum = $(obj).children("a:eq(1)");
        var flag = $(eum).is(":hidden");
        if (flag) {
            $(eum).show();
        } else {
            $(eum).hide();
        }
    }

    /*初始化数据*/
    getMyCompany($('#responsible_unit1'));//当前用户单位

    /*获取机构*/
    function initCompanySelect() {
        $.ajax({
            type: 'get',
            url: domainName + '/api-c/company/all',
            async: false,
            success: function (data) {
                $(data).each(function () {
                    if (this.identity == 'PARTY_A') {
                        $("#entrusting_party").append("<option value='" + this.signName + "'>" + this.signName + "</option>");
                    } else if (this.identity == 'PARTY_C') {
                        $("#management_unit").append("<option value='" + this.signName + "'>" + this.signName + "</option>");
                    } else if (this.identity == 'PARTY_B') {
                        $("#responsible_unit").append("<option value='" + this.signName + "'>" + this.signName + "</option>");
                    }
                })
            }
        });
    }

    //获取项目数据项目
    var id = getUrlParam("id");
    var type = getUrlParam("type");
    $('#item_id').val(id);
    $('#type').val(type);

    var apply_id = getUrlParam("apply_id");
    $('#apply_id').val(apply_id);
    getId();

    function show(d) {
        var str = '';
        if (type == 1) {
            str += '<tr style="height: 40px;">\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="2">变更前内容:</td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1">\n' +
                '                    <div class="field">\n' +
                '                        <span>项目名称</span>\n' +
                '                    </div>\n' +
                '                </td>\n' +
                '                <td class="mainTd_1 tdDorder" rowspan="1" colspan="1">\n' +
                '                    <div class="field">\n' +
                '                        <span>' + d.name + '</span>\n' +
                '                    </div>\n' +
                '                </td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1"></td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="2">变更后内容:</td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1">\n' +
                '                    <div class="field">\n' +
                '                        <span>项目名称</span>\n' +
                '                    </div>\n' +
                '                </td>\n' +
                '                <td class="mainTd_1 tdDorder" rowspan="1" colspan="2">\n' +
                '                    <div class="field">\n' +
                '                       <input type="text" name="name" placeholder="请输入" value="' + d.name + '">\n' +
                '                    </div>\n' +
                '                </td>\n' +


                '            </tr>';
            $('#old').append(str);


        } else if (type == 2) {
            str += '<tr style="height: 40px;">\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="2">变更前内容:</td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1">\n' +
                '                    <div class="field">\n' +
                '                        <span>项目承担单位</span>\n' +
                '                    </div>\n' +
                '                </td>\n' +
                '                <td class="mainTd_1 tdDorder" rowspan="1" colspan="1">\n' +
                '                    <div class="field">\n' +
                '                        <span>' + d.responsible_unit + '</span>\n' +
                '                    </div>\n' +
                '                </td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1"></td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="2">变更后内容:</td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1">\n' +
                '                    <div class="field">\n' +
                '                        <span>项目承担单位</span>\n' +
                '                    </div>\n' +
                '                </td>\n' +
                '                <td class="mainTd_1 tdDorder" rowspan="1" colspan="2">\n' +
                '                    <div class="field">\n' +
                '                        <select name="responsible_unit" id="responsible_unit" lay-filter="unit">\n' +
                '                            <option value=""></option>\n' +
                '                        </select>\n' +
                '                    </div>\n' +
                '                </td>\n' +


                '            </tr>';
            $('#old').append(str);

        } else if (type == 4) {
            str += '<tr style="height: 40px;">\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="2">变更前内容:</td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1">\n' +
                '                    <div class="field">\n' +
                '                        <span>实施期限</span>\n' +
                '                    </div>\n' +
                '                </td>\n' +
                '                <td class="mainTd_1 tdDorder" rowspan="1" colspan="1">\n' +
                '                    <div class="field">\n' +
                '                        <span>' + d.start_date.substring(0, 7) + ' - ' + d.end_date.substring(0, 7) + '</span>\n' +
                '                    </div>\n' +
                '                </td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1"></td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="2">变更后内容:</td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1">\n' +
                '                    <div class="field">\n' +
                '                        <span>实施期限</span>\n' +
                '                    </div>\n' +
                '                </td>\n' +
                '                <td class="mainTd_1 tdDorder" rowspan="1" colspan="2">\n' +
                '                    <div class="field">\n' +
                '                        <input type="text" name="period" placeholder="请输入" class="date" value="' + d.start_date.substring(0, 7) + ' - ' + d.end_date.substring(0, 7) + '">\n' +
                '                    </div>\n' +
                '                </td>\n' +


                '            </tr>';
            $('#old').append(str);


        } else if (type == 3 || type == 5) {

            str = ' <tr style="height: 24px;">\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1"></td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="8"></td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1"></td>\n' +
                '            </tr>\n' +
                '            <tr style="height: 40px;">\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1">变更前内容:</td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1"></td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1">\n' +
                '                    <div class="field">\n' +
                '                        <span>主要研究开发内容</span>\n' +
                '                    </div>\n' +
                '                </td>\n' +
                '                <td class="mainTd_1 tdDorder" rowspan="1" colspan="6">\n' +
                '                    <div class="field">\n' +
                '                        <textarea  placeholder="请输入" class="layui-textarea" readonly>' + d.research_contents + '</textarea>\n' +
                '                    </div>\n' +
                '                </td>\n' +

                '                <td class="mainTd_1" rowspan="1" colspan="1"></td>\n' +
                '            </tr>\n' +
                '            <tr style="height: 24px;">\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1"></td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="8"></td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1"></td>\n' +
                '            </tr>\n' +
                '            <tr style="height: 40px;">\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1">变更后内容:</td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1"></td>\n' +
                '                <td class="mainTd_1" rowspan="1" colspan="1">\n' +
                '                    <div class="field">\n' +
                '                        <span>主要研究开发内容</span>\n' +
                '                    </div>\n' +
                '                </td>\n' +
                '                <td class="mainTd_1 tdDorder" rowspan="1" colspan="6">\n' +
                '                    <div class="field">\n' +
                '                        <textarea name="research_contents" placeholder="请输入内容" class="layui-textarea">' + d.research_contents + '</textarea>\n' +
                '                    </div>\n' +
                '                </td>\n' +

                '                <td class="mainTd_1" rowspan="1" colspan="1"></td>\n' +
                '            </tr>';

            $('#old').append(str);
        }
    }

    function getId() {
        $.ajax({
            type: 'get',
            url: domainName + '/project-item/item/information/list',
            data: "id=" + id,
            async: false,
            contentType: "application/json; charset=utf-8",
            success: function (data) {

                var d = data[0];
                show(d);
                initCompanySelect();//单位选择
                $("#manage_unit").val(d.entrusting_party);
                $("#check_unit").val(d.management_unit);
            }
        })


    }


    function submit(status) {
        var information = $('#form1').serializeObject();
        var modifyApply = $('#form').serializeObject();
        modifyApply.status = status;
        var files = document.getElementsByName("accessory").length;
        var arr = [];
        var dayObj = $('input[name="accessory"]');
        for (var i = 0; i < dayObj.length; i++) {
            arr.push(dayObj[i].getAttribute('value'));
        }
        if (files == 1) {
            modifyApply.accessory = $("input[name='accessory']").val();
        } else {
            modifyApply.accessory = arr.join(',');
        }
        var data = {
            information: information,
            modifyApply: modifyApply
        };
        $.ajax({
            type: 'post',
            url: domainName + '/project-item/item/basic/modifyApply/base',
            contentType: "application/json; charset=utf-8",
            async: false,
            data: JSON.stringify(data),
            success: function (data) {
                var userIds = [];
                var userId = getPARTY_C(id);
                userIds.push(userId);
                var content = "您有一条变更申请待处理";
                var title = "您有一条变更申请待处理";
                sendMeaasge(content,title,userIds);

                layer.msg("成功", {shift: -1, time: 1000}, function () {
                    parent.location.reload();
                });
            }
        });
    }



</script>
</html>