<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" media="screen" href="../../../../css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="../../../../layui/css/layui.css">
    <link rel="stylesheet" type="text/css" media="screen" href="../css/details.css">
    <title>Title</title>
    <style>
        .layui-table thead tr {
            background: #dbe7f3;
            text-align: center;
        }

        .layui-table th {
            text-align: center;
            font-weight: 400;
        }

        .layui-btn {
            background-color: #a0a8c5;
        }
    </style>
</head>
<body>
<div class="module">
    <form class="layui-form" id="form1">
        <table lay-even class="layui-table" id="basis">
            <colgroup>
                <col width="20%">
                <col width="15%">
                <col width="15%">
                <col width="45%">
            </colgroup>
            <thead>
            <tr>
                <td>科目</td>
                <td>金额（万元）</td>
                <td>经费来源</td>
                <td>开支内容</td>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>
                    <input type="hidden" name="id" id="id" value="">
                    <input type="hidden" name="item_id" id="item_id" value="">
                    <select class="form-control input-sm" lay-verify="required" lay-ignore name="subject" id="subject">
                        <option value=''>请选择</option>
                    </select></td>
                <td><input class="form-control" lay-verify="required" placeholder="金额（万元）" type="text"
                           name="money" id="money"></td>
                <td><select class="form-control input-sm" lay-verify="required" lay-ignore name="source" id="source">
                    <option value=''>请选择</option>
                </select></td>
                <td><input class="form-control" lay-verify="required" placeholder="开支内容" type="text"
                           name="remark" id="remark">
                </td>
            </tr>
            </tbody>
        </table>
        <button class="layui-btn" lay-submit lay-filter="sub6" id="sub6" onclick="update();">提交</button>
    </form>
</div>
</body>
<script src="../../../../js/constant.js"></script>
<script type="text/javascript" src="../../../../js/libs/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../../../../js/jq.js"></script>
<script type="text/javascript" src="../../../../js/plugin/datatables/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="../../../../js/plugin/datatables/dataTables.bootstrap.min.js"></script>
<script type="text/javascript" src="../../../../layui/layui.js"></script>
<script type="text/javascript" src="../../../../js/common.js"></script>
<script type="text/javascript" src="../../../../js/my/permission.js"></script>
<script>
    var id = getUrlParam("id");
    $("#id").val(id);
    layui.use(['layer', 'form', 'laydate', 'upload'], function () {
        var layer = layui.layer
            , upload = layui.upload
            , form = layui.form
            , laydate = layui.laydate;
        lay('.date').each(function () {
            laydate.render({
                elem: this
                , showBottom: false
                , trigger: 'click'
            });
        });
        //监听提交
        form.on('submit(formDemo)', function (data) {
            layer.msg(JSON.stringify(data.field));
            return false;
        });
    });
    getTargetTypeAll("BUDGET_SUBJECT", $("#subject"));
    getTargetTypeAll("FUNDING_SOURCE", $("#source"));
    getFund(id);

    function getFund(id) {
        $.ajax({
            type: 'get',
            url: domainName + '/project-item/item/fund/list',
            data: "id=" + id,
            async: false,
            success: function (data) {
                var d = data[0];
                $("#subject").val(d.subject);
                $("#money").val(d.money);
                $("#source").val(d.source);
                $("#remark").val(d.remark);
                $("#item_id").val(d.item_id);
            }
        });

    }

    function getTargetTypeAll(sign, node) {
        $.ajax({
            type: 'get',
            url: domainName + '/api-label/label/tree/' + sign,
            async: false,
            success: function (data) {
                var ds = data[0].child;
                for (var i = 0; i < ds.length; i++) {
                    var d = ds[i];
                    var sign = d['sign'];
                    var name = d['content'];
                    node.append("<option value='" + sign + "'>" + name + "</option>");
                }
            }
        });
    }

    function update() {
        var formdata = $("#form1").serializeObject();
        $.ajax({
            type: 'put',
            url: domainName + '/project-item/item/fund',
            contentType: "application/json; charset=utf-8",
            async: false,
            data: JSON.stringify(formdata),
            success: function (data) {
                var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                parent.location.reload();//刷新父页面，注意一定要在关闭当前iframe层之前执行刷新
                layer.msg("成功", {shift: -1, time: 1000}, function () {
                    parent.layer.close(index); //再执行关闭
                });
            }
        })
    }
</script>
</html>