<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" media="screen" href="../../css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="../../css/dataTables.bootstrap.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="../../layui/css/layui.css">
</head>
<body>
<div>
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <header style="height: 100%">
            <div align="left">
                <table style="width: 100%">
                    <tr>
                        <td>
                            <form class="form-inline" onsubmit="return false" id="form">
                                <div class="form-group">
                                    姓名：<input id="createUserName" name="createUserName" type="text" class="form-control" placeholder="姓名">
                                    <button id="searchBt1"onclick="allWorkLog()" class="layui-btn layui-btn-sm"><i class="layui-icon">&#xe615;</i>搜索</button>
                                </div>
                            </form>
                        </td>
                        <td align="right">
                            <button class="layui-btn layui-btn-sm" onclick="back()">
                                <i class="layui-icon">&#xe65c;</i> 返回
                            </button>
                        </td>
                    </tr>
                </table>
            </div>
        </header>
        <div id="content">

        </div>
    </div>
</div>

<script src="../../js/constant.js"></script>
<script type="text/javascript" src="../../js/libs/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../../js/jq.js"></script>
<script type="text/javascript" src="../../js/plugin/datatables/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="../../js/plugin/datatables/dataTables.bootstrap.min.js"></script>
<script type="text/javascript" src="../../layui/layui.js"></script>
<script type="text/javascript" src="../../js/my/permission.js"></script>
<script src="../../js/common.js"></script>
<script>
    var form,layedit,laydate,index;
    var pers = checkPermission();
    layui.use(['form', 'layedit', 'laydate'], function(){
       form = layui.form;var layer = layui.layer;layedit = layui.layedit;laydate = layui.laydate;;
    });
    var itemId = getUrlParam("item_id");
    var userId = getUrlParam("userId");
    initWorkLog();
    function initWorkLog() {
        var params = {
            status: 0,
            itemId : itemId
        };
        var userName = $("#createUserName").val();
        if(!jQuery.isEmptyObject(userName)){
            params['createUserName'] = userName;
        }
        $.get(domainName+"/api-summary/work-log/list",params,function (data) {
            $("#content").empty();
            var str = ' <div class="widget-body no-padding"><table id="dt-table" class="table table-striped table-bordered table-hover" style="width:100%;margin-top: 5px">';
            str += '<thead><tr></tr><tr><th>标题</th><th>姓名</th><th>概要</th><th>提交日期</th><th>操作</th></tr></thead><tbody>';
            for(var i=data.length-1;i>=0;i--){
                var outline = data[i].outline.length>20?data[i].outline.substring(0,20)+'...': data[i].outline;
                str += '<tr id="'+data[i].id+'"><td>'+ data[i].title + '</td><td>' + data[0].createUserName + '</td><td>' + outline + '</td><td>' + formatDate1(data[i].createTime) + '</td><td>';
                if(data[i].status !=1 ) str += '<button class="layui-btn layui-btn-xs" title="审核" onclick="checkWorkLog('+data[i].id+')"><i class="layui-icon">&#xe642;</i></button>';
                str += '</td></tr>'
            }
            $("#content").append(str + '</tbody></table></div>');
        });
    }
    var h = $(window).height()-100;
    var w = $(window).width()-200;
    function checkWorkLog(id) {
        $.get(domainName+"/api-summary/work-log/list",{id:id},function (data) {
            var str = '<div style="text-align: center;margin: 20px;"><h1 style="font-weight: bold;">'+ data[0].title+'</h1><h3 id="text" style="margin-top: 5px;"> </h3></div>';
           str += '<div style="margin: 20px;"><div>'+ data[0].content + '</div>';
           str += '<div style="text-align: right;font-size: 18px;margin-top: 40px;margin-right:100px; font-weight: bold;">'+data[0].createUserName + '---'+ formatDate1(data[0].createTime)+'</div></div>';
           str += '<form class="layui-form" onsubmit="return false" ><div class="layui-form-item" pane=""><label class="layui-form-label" style="font-weight: bolder">审核:</label>' +
               '<div class="layui-input-block"><input type="radio" name="status" value="1" title="通过" checked=""><input type="radio" name="status" value="-1" title="驳回"></div></div>' +
               '<div class="layui-form-item layui-form-text"><label class="layui-form-label" style="font-weight: bolder">驳回原因:</label><div class="layui-input-block">' +
               '<textarea style="width: 90%" placeholder="如驳回请输入原因，通过不需要填写" name="remark" class="layui-textarea"></textarea></div></div><div class="layui-form-item" style="text-align: center">' +
               '<button class="layui-btn" onclick="updateWorkLog('+id+')">提交</button></div></form>';
            index = layer.open({
                title:"审核",
                type: 1,
                area: [w + 'px', h + 'px'],
                maxmin: true,
                shadeClose: true,
                content: str,
                end : function() {
                }
            });
            //执行部分表单元素才会自动修饰
            form.render('radio');
            $.get(domainName+"/project-item/item/target/list",{id:data[0].targetId},function(res){
                if(jQuery.isEmptyObject(res[0].target.trim())){
                    var val = res[0].content;
                    if(val.length>40){
                        val = val.substring(0,40) + '...';
                    }
                    $("#text").text("---" + val )
                }else{
                    $.get(domainName+"/api-label/label/tree/"+res[0].target,function(result){
                        $("#text").text("---" + result[0].content )
                    });
                }
            });
        });
    }

    function updateWorkLog(id) {
        var params =  $(".layui-form").serializeObject();
        params.id=id;
        $.ajax({
            url: domainName+"/api-summary/work-log",
            contentType: "application/json; charset=utf-8",
            data:JSON.stringify(params),
            type:"PUT",
            success:function (data) {
                layer.msg("成功", {shift: -1, time: 1000}, function(){
                    layer.close(index);
                    $("#"+id+"").empty();
                });
            }
        });
    }
    function back() {
        location.href='workLogList.html?id='+itemId+'&userId='+userId;
    }
</script>
</body>
</html>

