<!DOCTYPE html>
<html lang="en-us" id="extr-page">
<head>
    <title>工作日志起草</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
">

    <link rel="stylesheet" href="../../weui/lib/weui.min.css">
    <link rel="stylesheet" href="../../weui/css/jquery-weui.css">
    <link rel="stylesheet" href="../../weui/css/demos.css">
    <link rel="stylesheet" href="../../css/common.css">
</head>
<style>
    .weui-set-hide-val {
        margin-left: 15px;
    }
</style>
<body ontouchstart>
<form class="form-horizontal" onsubmit="return false" id="form">
    <div class="weui-cell">
        <div class="weui-cell__hd">
            <label class="weui-min-title">项目名称</label>
        </div>
        <div class="weui-cell__bd">
            <p class="itemName weui-set-hide-val"></p>
            <input type="hidden" id="itemName" name="itemName">
            <input type="hidden" id="itemId" name="itemId">
        </div>
    </div>
    <div class="weui-line" style="margin-top: 15px;"></div>
    <div class="weui-cells__title">相关信息</div>
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_primary" onclick="openPopup('../myProject/projectInfo.html')">基本信息</a>
            <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_primary" onclick="openPopup('../fundDetails/fundExpend.html')">经费使用</a>
            <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_primary" onclick="openPopup('../stageSummary/detailStageSummary.html')">阶段总结</a>
            <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_primary" onclick="openPopup('../workSummary/workSummary.html')">工作总结</a>
            <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_primary" onclick="openPopup('../skillSummary/skillSummary.html')">技术总结</a>
            <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_primary" onclick="openPopup('../auditfyApply/checkAuditfyApplyList.html')">查定申请</a>
            <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_primary" onclick="openPopup('../acceptance/checkAcceptance.html')">结题申请</a>
        </div>
    </div>
    <div class="targets">
        <div class="weui-imaginary-line"></div>
    </div>

    <div class="weui-line" style="margin-top: 15px;"></div>
    <div class="weui-cells__title">评审意见建议</div>
    <div class="weui-cells weui-cells_form">
        <div class="weui-cell">
            <div class="weui-cell__bd">
                <textarea class="weui-textarea" placeholder="请输入文本" id="evaluateContent" name="evaluateContent"
                          rows="20"></textarea>
            </div>
        </div>
    </div>
    <div class="weui-line"></div>
    <div class="weui-cells__title">评审结果</div>
    <div class="weui-cells weui-cells_checkbox">
        <label class="weui-cell weui-check__label " style="float: left;">
            <div class="weui-cell__hd">
                <input type="radio" class="weui-check" name="isPass" value="1" checked="checked">
                <i class="weui-icon-checked"></i>
            </div>
            <div class="weui-cell__bd">
                <p>通过</p>
            </div>
        </label>
        <label class="weui-cell weui-check__label" style="float: left;">
            <div class="weui-cell__hd">
                <input type="radio" class="weui-check" name="isPass" value="0">
                <i class="weui-icon-checked"></i>
            </div>
            <div class="weui-cell__bd">
                <p>待定</p>
            </div>
        </label>
        <label class="weui-cell weui-check__label" style="float: left;">
            <div class="weui-cell__hd">
                <input type="radio" class="weui-check" name="isPass" value="-1">
                <i class="weui-icon-checked"></i>
            </div>
            <div class="weui-cell__bd">
                <p>不通过</p>
            </div>
        </label>
    </div>
    <div class="weui-line"></div>
    <div class="weui-cell">
        <div class="weui-cell__hd">
            <label class="weui-min-title">评专家</label>
        </div>
        <div class="weui-cell__bd">
            <p class="userName weui-set-hide-val"></p>
            <input type="hidden" id="userName" name="userName">
            <input type="hidden" id="userId" name="userId">
        </div>
    </div>
    <div class="weui-line"></div>
    <div class="weui-cell">
        <div class="weui-cell__hd">
            <label class="weui-min-title">评审时间</label>
        </div>
        <div class="weui-cell__bd">
            <p class="createTime weui-set-hide-val"></p>
            <input type="hidden" id="createTime" name="createTime">
        </div>
    </div>
    <div class="weui-line"></div>

    <div class="weui-btn-area">
        <a class="weui-btn weui-btn_primary" href="javascript:" onclick="save()">提交</a>
    </div>
</form>

<div id="work-log-popup" class='weui-popup__container'>
    <div class="weui-popup__overlay"></div>
    <div class="weui-popup__modal work-log-content" style="background-color: white;">

    </div>
</div>

<div id="full" class='weui-popup__container'>
    <div class="weui-popup__overlay"></div>
    <div class="weui-popup__modal full" style="background-color: white;">
        <iframe src="../workLog/workLogList.html?itemId=1&userId=7&targetId=369" width="100%" height="100%"
                frameborder="0"></iframe>
        <a href="javascript:;" style="margin:40px 30px;" class="weui-btn weui-btn_primary close-popup">关闭</a>
    </div>
</div>

<script type="text/javascript" src="../../../../js/libs/jquery-3.3.1.min.js"></script>
<script src="../../weui/lib/fastclick.js"></script>
<script src="../../weui/js/jquery-weui.js"></script>
<script src="../../../../js/constant.js"></script>
<script type="text/javascript" src="../../../../js/jq.js"></script>
<script type="text/javascript" src="../../../../js/common.js"></script>
<script type="text/javascript">


    var itemId = getUrlParam("itemId");
    var userId = getUrlParam("userId");
    $('.createTime').html(formatDate4(new Date()));
    $('#itemId').val(itemId);
    $('#userId').val(userId);
    //专家信息
    $.get(domainName + '/project-user/user-anon/' + userId, function (res) {
        $('.userName').html(res[0].name);
        $('#userName').val(res[0].name);
    });

    //初始化项目信息
    $.get(domainName + "/project-item/item/information/list", {id: itemId}, function (res) {
        $('.itemName').html(res[0].name);
        $('#itemName').val(res[0].name);
    });
    $.get(domainName + "/project-item/item/indicators/list", {item_id: itemId}, function (res) {
        var str = '';
        $.each(res, function (i, item) {
            var type = '';
            var content = item['content'];
            var startEndTime = formatDate4(item['start_date']) + '---' + formatDate4(item['end_date']);
            if (item['count'] > 0) {

            } else {
                if (item['type'] == 'TECHNICAL_INDICATORS') {
                    type = '技术指标';
                }
                if (item['type'] == 'OTHER_INDICATORS') {
                    type = '其他指标';
                }
                if (item['type'] == 'ECONOMIC_INDICATORS') {
                    type = '经济指标';
                }
                if (item['type'] == 'INDICATORS_OF_TALENT_TEAM_CONS') {
                    type = '人才队伍建设指标';
                }
                var plan = item['plan'] == null ? '0%' : item['plan'];
                str += '<div class="target">\n' +
                    '        <div class="weui-cell">\n' +
                    '            <div class="weui-cell__hd">\n' +
                    '                <label class="weui-min-title">指标类型</label>\n' +
                    '            </div>\n' +
                    '            <div class="weui-cell__bd">\n' +
                    '                <p style="margin: 0 15px;">' + type + '</p>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="weui-line"></div>\n' +
                    '        <div class="weui-cell">\n' +
                    '            <div class="weui-cell__bd">\n' +
                    '                <label class="weui-min-title">指标内容</label>\n' +
                    '                <p style="margin: 0 15px;">' + item['content'] + '</p>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="weui-line"></div>\n' +
                    '        <div class="weui-cell">\n' +
                    '            <div class="weui-cell__hd">\n' +
                    '                <label class="weui-min-title">起止时间</label>\n' +
                    '            </div>\n' +
                    '            <div class="weui-cell__bd">\n' +
                    '                <p style="margin-left: 10px;">' + startEndTime + '</p>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="weui-line"></div>\n' +
                    '        <div class="weui-cell">\n' +
                    '            <div class="weui-cell__hd">\n' +
                    '                <label class="weui-min-title">指标进度</label>\n' +
                    '            </div>\n' +
                    '            <div class="weui-cell__bd">\n' +
                    '                <p style="margin-left: 10px;">' + plan + '</p>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="weui-line"></div>\n' +
                    '        <div class="weui-cell weui-cell_select weui-cell_select-after">\n' +
                    '            <div class="weui-cell__hd">\n' +
                    '                <label class="weui-min-title">完成情况</label>\n' +
                    '            </div>\n' +
                    '            <div class="weui-cell__bd" style="margin-left: 15px;">\n' +
                    '                <select class="weui-select" name="checked">\n' +
                    '                    <option value="">请评判指标完成情况</option>\n' +
                    '                    <option value="已完成">已完成</option>\n' +
                    '                    <option value="未完成">未完成</option>\n' +
                    '                </select>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="weui-line"></div>\n' +
                    '        <div class="weui-cell">\n' +
                    '            <div class="weui-cell__bd">\n' +
                    '                <label class="weui-min-title">指标评价</label>\n' +
                    '                <textarea class="weui-textarea" name="content" placeholder="请对该指标完成情况做出评价" rows="5"></textarea>\n' +
                    '               <input type="hidden" name="targetId" value="' + item['id'] + '">\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="weui-cell">\n' +
                    '            <div class="weui-cell__bd">\n' +
                    '                <a href="javascript:;" class="stage-summary-a" onclick="seeWorkLog(' + item['id'] + ')" >日志查询</a>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="weui-imaginary-line"></div>\n' +
                    '    </div>';
            }
        });
        $('.targets').append(str);
    });

    //保存数据
    function save() {
        var list = setObjectProperty('.target');
        var formdata = $("#form").serializeObject();
        formdata.list = list;
        $.ajax({
            type: 'post',
            url: domainName + '/api-summary/expert-evaluate',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(formdata),
            success: function (data) {
                $.toast('成功');
            }
        });
    }

    function setObjectProperty(attribute) {
        var target = $(attribute);
        var arr = new Array();
        for (var i = 0; i < target.length; i++) {
            var obj = {};
            var input = $(target[i]).find('input,select,textarea');
            var falg = false;
            for (var j = 0; j < input.length; j++) {
                falg = true;
                obj[$(input[j]).attr('name')] = $(input[j]).val();
                $(input[j]).attr('disabled', true)
            }
            if (falg) {
                arr.push(obj);
            }
            falg = false;
        }
        return arr;
    }

    function seeWorkLog(targetId) {
        $('.work-log-content').empty();
        $('.work-log-content').append('<iframe src="../workLog/workLogList.html?itemId=' + itemId + '&userId=' +
            userId + '&targetId=' + targetId + '" width="100%" height="100%" frameborder="0"></iframe>' +
            '<a href="javascript:;" style="margin:40px 30px;" class="weui-btn weui-btn_primary close-popup">返回评审页面</a>');
        $("#work-log-popup").popup();
    }

    function openPopup(url) {
        $('.full').empty();
        $('.full').append('<iframe src="' + url + '?itemId=' + itemId + '&userId=' +
            userId + '" width="100%" height="100%" frameborder="0"></iframe>' +
            '<a href="javascript:;" style="margin:40px 30px;" class="weui-btn weui-btn_primary close-popup">返回评审页面</a>');
        $("#full").popup();
    }

</script>
</body>
</html>