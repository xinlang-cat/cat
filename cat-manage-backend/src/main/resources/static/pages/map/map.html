<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
    <link rel="stylesheet" type="text/css" media="screen" href="../../css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="../../css/dataTables.bootstrap.min.css">
    <link rel="stylesheet" href="../../layui/css/layui.css" media="all"/>
    <link rel="stylesheet" href="http://api.map.baidu.com/library/SearchInfoWindow/1.4/src/SearchInfoWindow_min.css"/>
    <style>
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            font-family: "微软雅黑";
        }

        #allmap {

            height: 100%;
            overflow: hidden;
            margin: 0;
            font-family: "微软雅黑";
            float: left;
        }

        #data_manipulation {
            float: right;
        }
    </style>
</head>
<body>

<div id="allmap" class="col-md-9"></div>
<div id="data_manipulation" class="col-md-3">
    <div class="form-actions">
        <div class="row">
            <div style="margin-left: 20px;">
                <div style="font-size: 16px;font-weight: bold;"><img src="img/blue.png" style="margin-right: 25px;margin-bottom: 10px;"/>广西重点研发计划</div>
                <div style="font-size: 16px;font-weight: bold;"><img src="img/green.png" style="margin-right: 25px;margin-bottom: 10px;"/>电子信息</div>
            </div>
        </div>
    </div>

    <h3 style="margin-top: 20px;">类型分布</h3>
    <canvas id="myChart" style="float: left;width: 100%;"></canvas>
    <div style="width: 100%;float: left;"></div>
    <h3>状态分布</h3>
    <canvas id="container" style="float: left;width: 100%;"></canvas>
    <div style="width: 100%;float: left;"></div>
    <h3>时间分布</h3>
    <canvas id="container1" style="float: left;width: 100%;"></canvas>
</div>

</body>

<script src="../../js/constant.js"></script>
<script type="text/javascript" src="../../js/libs/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../../js/jq.js"></script>
<script type="text/javascript" src="../../layui/layui.js"></script>
<script type="text/javascript" src="../../js/plugin/datatables/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="../../js/plugin/datatables/dataTables.bootstrap.min.js"></script>
<script type="text/javascript" src="../../js/my/permission.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=4ZQc5ZktLFiK8tDzpBf7nDNHT7TcU6is"></script>
<script type="text/javascript"
        src="http://api.map.baidu.com/library/TextIconOverlay/1.2/src/TextIconOverlay_min.js"></script>
<script type="text/javascript"
        src="http://api.map.baidu.com/library/MarkerClusterer/1.2/src/MarkerClusterer_min.js"></script>
<!--加载鼠标绘制工具-->
<script type="text/javascript"
        src="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script>
<link rel="stylesheet" href="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css"/>
<!--加载检索信息窗口-->
<script type="text/javascript"
        src="http://api.map.baidu.com/library/SearchInfoWindow/1.4/src/SearchInfoWindow_min.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/library/GeoUtils/1.2/src/GeoUtils_min.js"></script>
<script type="text/javascript"
        src="http://api.map.baidu.com/library/TextIconOverlay/1.2/src/TextIconOverlay_min.js"></script>
<script type="text/javascript"
        src="http://api.map.baidu.com/library/MarkerClusterer/1.2/src/MarkerClusterer_min.js"></script>
<script src="https://gw.alipayobjects.com/os/antv/assets/f2/3.4.2/f2.min.js"></script>
<script type="text/javascript">
    var pers = checkPermission();
    //百度地图API功能
    var map = new BMap.Map("allmap", {}); // 创建Map实例
    var point = new BMap.Point(108.297233556, 22.8064929356);
    map.centerAndZoom(point, 6); // 初始化地图,设置中心点坐标和地图级别
    map.enableScrollWheelZoom(true); //开启鼠标滚轮缩放
    var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_TOP_LEFT});// 左上角，添加比例尺
    map.addControl(top_left_control);

    $(function () {
        initDimensioning();
    });

    //自定义图标
    var cyanIcon = new BMap.Icon("img/cyan.png", new BMap.Size(19, 25));
    var blueIcon = new BMap.Icon("img/blue.png", new BMap.Size(19, 25));
    var greenIcon = new BMap.Icon("img/green.png", new BMap.Size(19, 25));
    var orangeIcon = new BMap.Icon("img/orange.png", new BMap.Size(19, 25));
    var redIcon = new BMap.Icon("img/red.png", new BMap.Size(19, 25));
    var violetIcon = new BMap.Icon("img/violet.png", new BMap.Size(19, 25));
    var yellowIcon = new BMap.Icon("img/yellow.png", new BMap.Size(19, 25));

    function addMarker(point, content, opts, icon) {
        var marker = new BMap.Marker(point, {icon: icon});
        map.addOverlay(marker);
        addClickHandler(content, marker, opts);
    }


    function addClickHandler(content, marker, opts) {
        marker.addEventListener("click", function (e) {
            openInfo(content, e, opts)
        });
    }

    function openInfo(content, e, opts) {
        var p = e.target;
        var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
        var infoWindow = new BMap.InfoWindow(content, opts); // 创建信息窗口对象
        map.openInfoWindow(infoWindow, point); //开启信息窗口
    }

    //项目列表设置标注点
    function initDimensioning() {
        $.ajax({
            url: domainName + "/project-item/item/information/list",
            type: "get",
            contentType: "application/json; charset=utf-8",
            async: false,
            success: function (obj) {
                for (var i = 0; i < obj.length; i++) {
                    var status = '';
                    if (obj[i]['status'] == 0) {
                        status = "起草中";
                        continue;
                    } else if (obj[i]['status'] == 1) {
                        status = "起草中";
                        continue;
                    } else if (obj[i]['status'] == 2) {
                        status = "进行中";
                    } else if (obj[i]['status'] == 3) {
                        status = "结题中";
                    } else if (obj[i]['status'] == 4) {
                        status = "已结题";
                    } else if (obj[i]['status'] == 5) {
                        status = "终止中";
                    } else if (obj[i]['status'] == 6) {
                        status = "已终止";
                    }
                    var content = "";
                    content += '<div><span style="font-size: 14px;font-weight: bold;margin-right: 15px;">项目承担单位:</span><span>' + obj[i]['responsible_unit'] + '</span></div>';
                    content += '<div><span style="font-size: 14px;font-weight: bold;margin-right: 15px;">项目监理单位:</span><span>' + obj[i]['management_unit'] + '</span></div>';
                    content += '<div><span style="font-size: 14px;font-weight: bold;margin-right: 15px;">项目起止时间:</span><span>' + formatDate4(obj[i]['start_date']) + '---' + formatDate4(obj[i]['end_date']) + '</span></div>';
                    content += '<div><span style="font-size: 14px;font-weight: bold;margin-right: 15px;">项目起止时间:</span><span>' + status + '</span></div>';
                    content += '<button class="btn btn-primary" style="margin: 10px 20px 0 0;" onclick="showStage(' + obj[i]['id'] + ')">阶段总结</button>';
                    content += '<button class="btn btn-primary" style="margin: 10px 20px 0 0;" onclick="showAudit(' + obj[i]['id'] + ')">查定报告</button>';
                    content += '<button class="btn btn-primary" style="margin: 10px 20px 0 0;" onclick="showSkill(' + obj[i]['id'] + ')">技术总结</button>';
                    content += '<button class="btn btn-primary" style="margin: 10px 20px 0 0;" onclick="showWork(' + obj[i]['id'] + ')">工作总结</button>';
                    content += '<button class="btn btn-primary" style="margin: 10px 20px 0 0;" onclick="showTarget(' + obj[i]['id'] + ')">项目指标</button>';
                    content += '<button class="btn btn-primary" style="margin: 10px 20px 0 0;" onclick="showFund(' + obj[i]['id'] + ')">经费使用</button>';
                    var opts = {
                        width: 500,
                        height: 200,
                        title: obj[i]['name'],
                        enableMessage: true
                    };
                    var color = null;
                    if(obj[i]['type'] == 'EMPHASIS_RESEARCH_AND_DEVELOPM'){
                        color = blueIcon;
                    }
                    if(obj[i]['type'] == 'ELECTRONIC_INFORMATION'){
                        color = greenIcon;
                    }
                    addMarker(new BMap.Point(obj[i]['lng'], obj[i]['lat']), content, opts,color);
                }
            }
        });
    }

    layui.use(['layer'], function () {
        var layer = layui.layer;
    });

    var w = $(window).width() - 30;

    function showAudit(itemId) {
        layer.open({
            title: "查定报告",
            type: 2,
            area: [w + 'px', window.screen.height - 370 + 'px'],
            maxmin: true,
            shadeClose: true,
            content: ['../auditApply/checkedApplyList.html?item_id=' + itemId]
        });
    }

    function showSkill(itemId) {
        layer.open({
            title: "技术总结",
            type: 2,
            area: [w + 'px', window.screen.height - 370 + 'px'],
            maxmin: true,
            shadeClose: true,
            content: ['../summary/generateSkillReport.html?itemId=' + itemId]
        });
    }

    function showWork(itemId) {
        layer.open({
            title: "工作总结",
            type: 2,
            area: [w + 'px', window.screen.height - 370 + 'px'],
            maxmin: true,
            shadeClose: true,
            content: ['../summary/generateWorkReport.html?itemId=' + itemId]

        });
    }

    function showTarget(itemId) {
        layer.open({
            title: "项目指标",
            type: 2,
            area: [w + 'px', window.screen.height - 370 + 'px'],
            maxmin: true,
            shadeClose: true,
            content: ['../indicator/readIndicatorList.html?itemId=' + itemId]

        });
    }

    function showStage(itemId) {
        layer.open({
            title: "阶段总结",
            type: 2,
            area: [w + 'px', window.screen.height - 370 + 'px'],
            maxmin: true,
            shadeClose: true,
            content: ['../list-layout/pages/stage-summary/stageSummaryList.html?item_id=' + itemId]

        });
    }

    function showFund(itemId) {
        layer.open({
            title: "经费使用",
            type: 2,
            area: [w + 'px', window.screen.height - 370 + 'px'],
            maxmin: true,
            shadeClose: true,
            content: ['../list-layout/pages/fundUse/readFundBudget.html?id=' + itemId]
        });
    }

    initData();


    function initData() {
        var contents = new Array();//项目类型
        var signs = new Array();//项目类型标识
        var counts = new Array();//项目类型数量
        var statuss = new Array();//项目类型
        var counts1 = new Array();//项目进度数量
        var countItem = 0;
        var dataArr = getMonths();
        var counts2 = getCount2();

        //生成月份数组
        $.ajax({
            type: 'get',
            url: domainName + '/api-label/label/tree/' + "PLAN_CATEGOR",
            async: false,
            success: function (data) {
                $(data[0].child).each(function () {
                    var content = this.content;
                    contents.push(content);
                    var sign = this.sign;
                    signs.push(sign);
                    counts.push(0);
                });
            }
        });
        $.ajax({
            type: 'get',
            url: domainName + "/project-item/item/information/list",
            async: false,
            success: function (data) {
                $(data).each(function () {

                    var status = "";
                    if (this.status <= 1) {
                        return true;
                    } else if (this.status == 2) {
                        status = "进行中";
                    } else if (this.status == 3) {
                        status = "结题中";
                    } else if (this.status == 4) {
                        status = "已结题";
                    } else if (this.status == 5) {
                        status = "终止中";
                    } else if (this.status == 6) {
                        status = "已终止";
                    }
                    countItem++;
                    var b = statuss.indexOf(status);
                    if (b == -1) {

                        statuss.push(status);
                        counts1.push(1);
                    } else {
                        counts1[b] = counts1[b] + 1;
                    }
                    var sign = this.type;
                    var a = signs.indexOf(sign);
                    counts[a] = counts[a] + 1;
                    var start = formatDateY(this.start_date);
                    var b = dataArr.indexOf(start);
                    counts2[b] = counts2[b] + 1;
                });
            }
        });

        const data = [];
        const data1 = [];
        const data2 = [];
        for (var i = 0; i < counts.length; i++) {
            var res = {"genre": contents[i], "sold": counts[i]};
            data.push(res);
        }
        for (var i = 0; i < statuss.length; i++) {
            var math = counts1[i] / countItem * 1000;
            math = Math.round(math);
            var res1 = {"name": statuss[i], "percent": math/10, "a": "1"};
            data1.push(res1);
        }
        for (var i = 0; i < 12; i++) {
            var res2 = {"year": dataArr[i], "sales": counts2[i]};
            data2.push(res2);
        }

        // Step 1: 创建 Chart 对象
        const chart = new F2.Chart({
            id: 'myChart',
            pixelRatio: window.devicePixelRatio, // 指定分辨率
        });

        // Step 2: 载入数据源
        chart.source(data);

        // Step 3：创建图形语法，绘制柱状图，由 genre 和 sold 两个属性决定图形位置，genre 映射至 x 轴，sold 映射至 y 轴
        chart
            .interval()
            .position('genre*sold')
            .color('genre');

        // Step 4: 渲染图表
        chart.render();

        //====================================================================================================

        const map = {};
        data1.forEach(function (obj) {
            map[obj.name] = obj.percent + '%';
        });

        const chart1 = new F2.Chart({
            id: 'container',
            pixelRatio: window.devicePixelRatio,
            padding: [20, 'auto']
        });
        chart1.source(data1, {
            percent: {
                formatter: function formatter(val) {
                    return val + '%';
                }
            }
        });
        chart1.tooltip(false);
        chart1.legend({
            position: 'right',
            itemFormatter: function itemFormatter(val) {
                return val + '    ' + map[val];
            }
        });
        chart1.coord('polar', {
            transposed: true,
            innerRadius: 0.7,
            radius: 0.85
        });
        chart1.axis(false);
        chart1.interval()
            .position('a*percent')
            .color('name', ['#FE5D4D', '#3BA4FF', '#737DDE'])
            .adjust('stack');

        chart1.guide().html({
            position: ['50%', '45%'],
            html: `<div style="width: 250px;height: 40px;text-align: center;">
      <div style="font-size: 16px">项目总数</div>
      <div style="font-size: 24px">` + countItem + `</div>
    </div>`
        });
        chart1.render();

        //====================================================================================================

        const chart2 = new F2.Chart({
            id: 'container1',
            pixelRatio: window.devicePixelRatio
        });

        chart2.source(data2, {
            sales: {
                tickCount: 5
            }
        });
        chart2.coord({
            transposed: true
        });
        chart2.tooltip({
            showItemMarker: false,
            onShow: function onShow(ev) {
                const items = ev.items;
                items[0].name = null;
                items[0].name = items[0].title;
                items[0].value = '¥ ' + items[0].value;
            }
        });
        chart2.interval().position('year*sales');
        chart2.render();
    }

    function getMonths() {
        var dataArr = [];
        var data = new Date();
        var year = data.getFullYear();
        data.setMonth(data.getMonth() + 1, 1); //获取到当前月份,设置月份
        for (var i = 0; i < 12; i++) {
            data.setMonth(data.getMonth() - 1); //每次循环一次 月份值减1
            var m = data.getMonth() + 1;
            m = m < 10 ? "0" + m : m;
            dataArr.push(data.getFullYear() + "-" + m);
        }
        return dataArr;
    }

    function getCount2() {
        var dataCoun = [];

        for (var i = 0; i < 12; i++) {

            dataCoun.push(0);
        }
        return dataCoun;
    }

    function formatDateY(now) {
        var now = new Date(now);
        var year = now.getFullYear();
        var month = now.getMonth() + 1;
        return year + "-" + fixZero(month, 2);
    }

</script>
</html>