<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
    <link rel="stylesheet" type="text/css" media="screen" href="../../css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="../../css/dataTables.bootstrap.min.css">
    <link rel="stylesheet" href="../../layui/css/layui.css" media="all"/>

    <link rel="stylesheet" href="http://api.map.baidu.com/library/SearchInfoWindow/1.4/src/SearchInfoWindow_min.css"/>
    <style>
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            font-family: "微软雅黑";
        }

        #allmap {

            height: 100%;
            overflow: hidden;
            margin: 0;
            font-family: "微软雅黑";
            float: left;
        }

        #data_manipulation {
            float: right;
        }
    </style>
</head>
<body>
<div style="position: fixed;top: 0;width: 100%;height: 60px;z-index: 1;opacity: 100%;">
    <div style="position: absolute;right: 2px;top: 15px;">
        <button class="layui-btn" type="button" id="hide" onclick="hideTB111()" style="display: none;"><i class="layui-icon" ></i>统计图表</button>
    </div>
    <div style="position: absolute;right: 25%;top: 15px;">
        <button class="layui-btn" type="button"  id="show" onclick="showTB()"><i
                class="layui-icon"></i>全屏地图</button>
    </div>
</div>


<div id="allmap" class="col-md-9"></div>
<div id="data_manipulation" class="col-md-3">
    <!--<div class="form-actions">
        <div class="row">
            <div style="margin-left: 20px;">
                <div style="font-size: 18px; width: 50%;float: left;"><img
                        src="img/blue.png" style="margin-right: 10px;height: 18px"/>广西重点研发计划
                </div>
                <div style="font-size: 18px;width: 50%;float: left;">
                    <img
                            src="img/green.png" style="margin-right: 10px;height: 18px"/>电子信息
                </div>
            </div>
        </div>
    </div>-->

    <div style="width: 100%;">
        <h3 style="text-align: center">项目统计图表</h3>
        <span style="font-size: 18px;float: left;margin-right: 20px;">列表展示</span>
        <select name="interest" lay-filter="aihao" style="float: left;" onchange="wetherShow()" id="table">
            <option value="0">展示</option>
            <option value="1" selected>不展示</option>
        </select>
    </div>
    <fieldset class="layui-elem-field layui-field-title" style="margin-bottom: 10px;"></fieldset>
    <canvas style="float: left;width: 100%;height: 5px;"></canvas>
    <div style="width: 100%;">
        <span style="font-size: 18px;float: left;margin-right: 20px;">类型统计</span>
        <select name="interest" lay-filter="aihao" style="float: left;" onchange="byType()" id="type">
            <option value="0">全部</option>
        </select>
    </div>
    <canvas id="myChart" style="float: left;width: 100%;"></canvas>

    <div style="width: 100%;">
        <span style="font-size: 18px;float: left;margin-right: 20px;">状态统计</span>
        <select name="interest" lay-filter="aihao" style="float: left;" onchange="byStatus()" id="status">
            <option value="0">全部</option>
            <option value="1">进行中</option>
            <option value="2">结题中</option>
            <option value="3">已结题</option>
            <option value="4">未结题</option>
        </select>
    </div>
    <canvas id="container" style="float: left;"></canvas>

    <div style="width: 100%;">
        <span style="font-size: 18px;float: left;margin-right: 20px;">新增统计</span>
        <input type="text" style="width: 17%;float: left" id="test1"><span style="float: left;">月及往前5个月</span>
    </div>
    <canvas id="container2" style="float: left;width: 100%;"></canvas>

</div>

</body>

<script src="../../js/constant.js"></script>
<script type="text/javascript" src="../../js/libs/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../../js/jq.js"></script>
<script type="text/javascript" src="../../layui/layui.js"></script>
<script type="text/javascript" src="../../layui/layui.all.js"></script>
<script type="text/javascript" src="../../js/plugin/datatables/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="../../js/plugin/datatables/dataTables.bootstrap.min.js"></script>
<script type="text/javascript" src="../../js/my/permission.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=4ZQc5ZktLFiK8tDzpBf7nDNHT7TcU6is"></script>
<script type="text/javascript"
        src="http://api.map.baidu.com/library/TextIconOverlay/1.2/src/TextIconOverlay_min.js"></script>
<script type="text/javascript"
        src="http://api.map.baidu.com/library/MarkerClusterer/1.2/src/MarkerClusterer_min.js"></script>
<!--加载鼠标绘制工具-->
<script type="text/javascript"
        src="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script>
<link rel="stylesheet" href="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css"/>
<!--加载检索信息窗口-->
<script type="text/javascript"
        src="http://api.map.baidu.com/library/SearchInfoWindow/1.4/src/SearchInfoWindow_min.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/library/GeoUtils/1.2/src/GeoUtils_min.js"></script>
<script type="text/javascript"
        src="http://api.map.baidu.com/library/TextIconOverlay/1.2/src/TextIconOverlay_min.js"></script>
<script type="text/javascript"
        src="http://api.map.baidu.com/library/MarkerClusterer/1.2/src/MarkerClusterer_min.js"></script>
<script src="https://gw.alipayobjects.com/os/antv/assets/f2/3.4.2/f2.min.js"></script>

<script type="text/javascript">

    var counts4 = new Array();
    var items = new Array(); //项目原始数据
    var contents = new Array();//项目类型
    var counts = new Array();//项目类型数量
    var countItem = 0;
    var dataArr = getMonths();
    var statuss1 = ["进行中", "结题中", "已结题", "未结题"];
    var statussMath = [0, 0, 0, 0];
    var signs = new Array();//项目类型标识
    var selectItem = new Array(); //筛选过后的项目
    //获取当年年月
    var myDate = new Date();
    var tYear = myDate.getFullYear();
    var tMonth = myDate.getMonth();
    var today = formatDate4(myDate);
    var show = false;
    var m = tMonth + 1;
    if (m.toString().length == 1) {
        m = "0" + m;
        //将10一下的月份前加0
    }
    var now = tYear + '-' + m;


    const chart = new F2.Chart({
        id: 'myChart',
        pixelRatio: window.devicePixelRatio, // 指定分辨率
    });
    const chart1 = new F2.Chart({
        id: 'container',
        pixelRatio: window.devicePixelRatio,
        padding: [20, 'auto']
    });
    const chart3 = new F2.Chart({
        id: 'container2',
        pixelRatio: window.devicePixelRatio
    });
    initSelectData('PLAN_CATEGOR', $('#type'));//计划类别


    function initSelectData(sign, node) {
        $.ajax({
            type: 'get',
            url: domainName + '/api-label/label/tree/' + sign,
            async: false,
            success: function (data) {
                var ds = data[0].child;
                $(ds).each(function () {
                    node.append('<option value=' + this.sign + '>' + this.content + '</option>');
                });
            }
        })
    }

    var form, layer, layedit;

    layui.use(['form', 'layedit', 'laydate'], function () {
        form = layui.form
            , layer = layui.layer
            , layedit = layui.layedit
        var laydate = layui.laydate;

        form.on('switch(switchTest)', function (data) {
            layer.msg('开关checked：' + (this.checked ? 'true' : 'false'), {
                offset: '6px'
            });
            layer.tips('温馨提示：请注意开关状态的文字可以随意定义，而不仅仅是ON|OFF', data.othis)
        });

        laydate.render({
            elem: '#test1' //指定元素
            , type: 'month'
            //日期时间被切换后的回调,年月日时间被切换时都会触发。
            , change: function (value, date, endDate) {
                console.log(value); //得到日期生成的值，如：2017-08-18
                console.log(date); //得到日期时间对象：{year: 2017, month: 8, date: 18, hours: 0, minutes: 0, seconds: 0}
                console.log(endDate); //得结束的日期时间对象，开启范围选择（range: true）才会返回。对象成员同上。
            }
            //控件选择完毕后的回调,点击日期、清空、现在、确定均会触发。
            , done: function (value, date, endDate) {
                console.log(value); //得到日期生成的值，如：2017-08-18
                console.log(date); //得到日期时间对象：{year: 2017, month: 8, date: 18, hours: 0, minutes: 0, seconds: 0}
                console.log(endDate); //得结束的日期时间对象，开启范围选择（range: true）才会返回。对象成员同上。
                //清空筛选后的项目数组，再进行添加

                $("#status").val(0);
                $("#type").val(0);
                map.clearOverlays();
                var counts5 = getCountA(counts.length);
                var dataArr1 = [];
                if (value.length > 0) {
                    var data = new Date(value);
                    var year = data.getFullYear();
                    data.setMonth(data.getMonth() - 6, 1); //获取到当前月份,设置月份
                    for (var i = 0; i < 6; i++) {
                        data.setMonth(data.getMonth() + 1); //每次循环一次 月份值减1
                        var m = data.getMonth() + 1;
                        m = m < 10 ? "0" + m : m;
                        dataArr1.push(data.getFullYear() + "-" + m);
                    }
                } else {
                    dataArr1 = dataArr;
                }
                showTable3(items, counts5, dataArr1);


            }
        });

    });

    function showTable3(data, counts5, dataArr1) {
        selectItem = [];
        $(data).each(function () {
            var sign = this.type;
            var a = signs.indexOf(sign);
            counts[a] = counts[a] + 1;
            var start = formatDateY(this.start_date);
            var b = dataArr1.indexOf(start);
            if (b >= 0) {
                counts5[a * 6 + b] = counts5[a * 6 + b] + 1;
                selectItem.push(this);
                inMap(this);
            }
        });

        if (selectItem.length > 0) {
            showTable(selectItem);
        }

        const data2 = [];

        for (var i = 0; i < counts.length; i++) {
            for (var a = 0; a < dataArr1.length; a++) {
                var res2 = {"name": contents[i], "月份": dataArr1[a], "月均降雨量": counts5[i * 6 + a]};
                data2.push(res2);
            }
        }
        chart3.clear(); // 清理所有chart.source(data);
        chart3.source(data2);
        chart3.tooltip({
            custom: true, // 自定义 tooltip 内容框
            onChange: function onChange(obj) {
                const legend = chart3.get('legendController').legends.top[0];
                const tooltipItems = obj.items;
                const legendItems = legend.items;
                const map = {};
                legendItems.forEach(function (item) {
                    map[item.name] = _.clone(item);
                });
                tooltipItems.forEach(function (item) {
                    const name = item.name;
                    const value = item.value;
                    if (map[name]) {
                        map[name].value = value;
                    }
                });
                legend.setItems(_.values(map));
            },
            onHide: function onHide() {
                const legend = chart3.get('legendController').legends.top[0];
                legend.setItems(chart.getLegendItems().country);
            }
        });

        chart3.interval()
            .position('月份*月均降雨量')
            .color('name', ['#1890ff', '#2fc25b', '#ffa500', '#ff030b', '#884898', '#e1cf00', '#00b634'])
            .adjust({
                type: 'dodge',
                marginRatio: 0.05 // 设置分组间柱子的间距
            });
        chart3.render();
    }


    var pers = checkPermission();
    //百度地图API功能
    var map = new BMap.Map("allmap", {}); // 创建Map实例
    var point = new BMap.Point(108.297233556, 22.8064929356);
    map.centerAndZoom(point, 6); // 初始化地图,设置中心点坐标和地图级别
    map.enableScrollWheelZoom(true); //开启鼠标滚轮缩放
    var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_TOP_LEFT});// 左上角，添加比例尺
    map.addControl(top_left_control);

    //自定义图标
    var cyanIcon = new BMap.Icon("img/cyan.png", new BMap.Size(19, 25));
    var blueIcon = new BMap.Icon("img/blue.png", new BMap.Size(19, 25));
    var greenIcon = new BMap.Icon("img/green.png", new BMap.Size(19, 25));
    var orangeIcon = new BMap.Icon("img/orange.png", new BMap.Size(19, 25));
    var redIcon = new BMap.Icon("img/red.png", new BMap.Size(19, 25));
    var violetIcon = new BMap.Icon("img/violet.png", new BMap.Size(19, 25));
    var yellowIcon = new BMap.Icon("img/yellow.png", new BMap.Size(19, 25));

    var diagrams = [blueIcon, greenIcon, orangeIcon, redIcon, violetIcon, yellowIcon, cyanIcon];

    function addMarker(point, content, opts, icon) {
        var marker = new BMap.Marker(point, {icon: icon});
        map.addOverlay(marker);
        addClickHandler(content, marker, opts);
    }


    function addClickHandler(content, marker, opts) {
        marker.addEventListener("click", function (e) {
            openInfo(content, e, opts)
        });
    }

    function openInfo(content, e, opts) {
        var p = e.target;
        var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
        var infoWindow = new BMap.InfoWindow(content, opts); // 创建信息窗口对象
        map.openInfoWindow(infoWindow, point); //开启信息窗口
    }


    layui.use(['layer'], function () {
        var layer = layui.layer;
    });

    var w = $(window).width() - 30;

    function showAudit(itemId) {
        layer.open({
            title: "查定报告",
            type: 2,
            area: [w + 'px', window.screen.height - 370 + 'px'],
            maxmin: true,
            shadeClose: true,
            content: ['../auditApply/checkedApplyList.html?item_id=' + itemId]
        });
    }

    function showSkill(itemId) {
        layer.open({
            title: "技术总结",
            type: 2,
            area: [w + 'px', window.screen.height - 370 + 'px'],
            maxmin: true,
            shadeClose: true,
            content: ['../summary/generateSkillReport.html?itemId=' + itemId]
        });
    }

    function showWork(itemId) {
        layer.open({
            title: "工作总结",
            type: 2,
            area: [w + 'px', window.screen.height - 370 + 'px'],
            maxmin: true,
            shadeClose: true,
            content: ['../summary/generateWorkReport.html?itemId=' + itemId]

        });
    }

    function showTarget(itemId) {
        layer.open({
            title: "项目指标",
            type: 2,
            area: [w + 'px', window.screen.height - 370 + 'px'],
            maxmin: true,
            shadeClose: true,
            content: ['../indicator/readIndicatorList.html?itemId=' + itemId]

        });
    }

    function showStage(itemId) {
        layer.open({
            title: "阶段总结",
            type: 2,
            area: [w + 'px', window.screen.height - 370 + 'px'],
            maxmin: true,
            shadeClose: true,
            content: ['../list-layout/pages/stage-summary/stageSummaryList.html?item_id=' + itemId]

        });
    }

    function showFund(itemId) {
        layer.open({
            title: "经费使用",
            type: 2,
            area: [w + 'px', window.screen.height - 370 + 'px'],
            maxmin: true,
            shadeClose: true,
            content: ['../list-layout/pages/fundUse/readFundBudget.html?id=' + itemId]
        });
    }

    initData();


    function initData() {

        //生成月份数组
        $.ajax({
            type: 'get',
            url: domainName + '/api-label/label/tree/' + "PLAN_CATEGOR",
            async: false,
            success: function (data) {
                $(data[0].child).each(function () {
                    var content = this.content;
                    contents.push(content);
                    var sign = this.sign;
                    signs.push(sign);
                    counts.push(0);
                });

            }
        });
        counts4 = getCountA(counts.length);
        $.ajax({
            type: 'get',
            url: domainName + "/project-item/item/information/list",
            async: false,
            success: function (data) {

                $(data).each(function () {

                    if (this.status <= 1) {
                        return true;
                    } else if (this.status == 2 && formatDate4(this.end_date) >= today) {
                        //进行中，并且没到结题时间
                        statussMath[0] = statussMath[0] + 1;

                    } else if (this.status == 3 || this.status == 5) {
                        statussMath[1] = statussMath[1] + 1;

                    } else if (this.status == 4 || this.status == 6) {
                        statussMath[2] = statussMath[2] + 1;

                    } else if (this.status == 2 && formatDate4(this.end_date) < today) {
                        statussMath[3] = statussMath[3] + 1;
                    }
                    items.push(this);
                    countItem++;//项目总数变化
                    inMap(this);
                    var sign = this.type;
                    var a = signs.indexOf(sign);
                    counts[a] = counts[a] + 1;//将对应状态的项目数量改变
                    var start = formatDateY(this.start_date);
                    var b = dataArr.indexOf(start);//获取项目开始时间对应的下标位置
                    if (b >= 0) {
                        counts4[a * 6 + b] = counts4[a * 6 + b] + 1;
                    }
                });


            }
        });

        const data = [];
        const data1 = [];
        const data2 = [];
        for (var i = 0; i < counts.length; i++) {
            var res = {"genre": contents[i], "sold": counts[i]};
            data.push(res);
        }

        for (var i = 0; i < statuss1.length; i++) {
            var math = statussMath[i] / countItem * 1000;
            math = Math.round(math);
            var res1 = {"name": statuss1[i], "percent": math / 10, "a": "1"};
            data1.push(res1);
        }
        for (var i = 0; i < counts.length; i++) {
            for (var a = 0; a < dataArr.length; a++) {
                var res2 = {"name": contents[i], "月份": dataArr[a], "月均降雨量": counts4[i * 6 + a]};

                data2.push(res2);
            }
        }

        // Step 1: 创建 Chart 对象


        // Step 2: 载入数据源
        chart.source(data);

        // Step 3：创建图形语法，绘制柱状图，由 genre 和 sold 两个属性决定图形位置，genre 映射至 x 轴，sold 映射至 y 轴
        chart
            .interval()
            .position('genre*sold')
            .color('genre', ['#1890ff', '#2fc25b', '#ffa500', '#ff030b', '#884898', '#e1cf00', '#00b634']);

        // Step 4: 渲染图表
        chart.render();

        //====================================================================================================

        const map = {};
        data1.forEach(function (obj) {
            map[obj.name] = obj.percent + '%';
        });


        chart1.source(data1, {
            percent: {
                formatter: function formatter(val) {
                    return val + '%';
                }
            }
        });
        chart1.tooltip(false);
        chart1.legend({
            position: 'right',
            itemFormatter: function itemFormatter(val) {
                return val + '    ' + map[val];
            }
        });
        chart1.coord('polar', {
            transposed: true,
            innerRadius: 0.7,
            radius: 0.85
        });
        chart1.axis(false);
        chart1.interval()
            .position('a*percent')
            .color('name', ['#fedc4a', '#3BA4FF', '#737DDE', '#FE5D4D'])
            .adjust('stack');

        chart1.guide().html({
            position: ['50%', '45%'],
            html: `<div style="width: 200px;height: 30px;text-align: center;">
      <div style="font-size: 18px">项目总数</div>
      <div style="font-size: 20px">` + countItem + `</div>
    </div>`
        });
        chart1.render();


        chart3.source(data2);
        chart3.tooltip({
            custom: true, // 自定义 tooltip 内容框
            onChange: function onChange(obj) {
                const legend = chart3.get('legendController').legends.top[0];
                const tooltipItems = obj.items;
                const legendItems = legend.items;
                const map = {};
                legendItems.forEach(function (item) {
                    map[item.name] = _.clone(item);
                });
                tooltipItems.forEach(function (item) {
                    const name = item.name;
                    const value = item.value;
                    if (map[name]) {
                        map[name].value = value;
                    }
                });
                legend.setItems(_.values(map));
            },
            onHide: function onHide() {
                const legend = chart3.get('legendController').legends.top[0];
                legend.setItems(chart.getLegendItems().country);
            }
        });

        chart3.interval()
            .position('月份*月均降雨量')
            .color('name', ['#1890ff', '#2fc25b', '#ffa500', '#ff030b', '#884898', '#e1cf00', '#00b634'])
            .adjust({
                type: 'dodge',
                marginRatio: 0.05 // 设置分组间柱子的间距
            });
        chart3.render();
    }

    function getMonths() {
        var dataArr = [];
        var data = new Date();
        var year = data.getFullYear();
        data.setMonth(data.getMonth() - 6, 1); //获取到当前月份,设置月份
        for (var i = 0; i < 6; i++) {
            data.setMonth(data.getMonth() + 1); //每次循环一次 月份值减1
            var m = data.getMonth() + 1;
            m = m < 10 ? "0" + m : m;
            dataArr.push(data.getFullYear() + "-" + m);
        }
        return dataArr;
    }

    function getCount2() {
        var dataCoun = [];
        for (var i = 0; i < 6; i++) {
            dataCoun.push(0);
        }
        return dataCoun;
    }

    function getCountA(a) {
        var dataCoun = [];
        var dataCoun = [];
        for (var b = 0; b < a; b++) {
            for (var i = 0; i < 6; i++) {
                dataCoun.push(0);
            }
        }

        return dataCoun;
    }

    function formatDateY(now) {
        var now = new Date(now);
        var year = now.getFullYear();
        var month = now.getMonth() + 1;
        return year + "-" + fixZero(month, 2);
    }

    function wetherShow() {
        var table = $("#table").val();
        if (table == 0) {
            show = true;
        } else {
            show = false;
        }
    }

    function byType() {
        selectItem = [];
        $("#status").val(0);
        $("#test1").val("");
        map.clearOverlays();
        var type = $("#type").val();
        if (type == 0) {
            $(items).each(function () {
                inMap(this);
            });
        }
        $(items).each(function () {
            var sign = this.type;
            if (type == sign) {
                selectItem.push(this);
                inMap(this);
            }
        });
        if (type == 0) {
            if (items.length > 0) {
                showTable(items);
            }
        } else {
            if (selectItem.length > 0) {
                showTable(selectItem);
            }
        }
    }

    function byStatus() {
        selectItem = [];
        $("#type").val(0);
        $("#test1").val("");

        map.clearOverlays();
        var status = $("#status").val();
        $(items).each(function () {
            if (status == 0) {
                $(items).each(function () {
                    inMap(this);

                });
            } else if (status == 1) {
                if (this.status == 2 && formatDate4(this.end_date) >= today) {
                    selectItem.push(this);
                    inMap(this);

                }
            } else if (status == 2) {
                if (this.status == 3 || this.status == 5) {
                    selectItem.push(this);
                    inMap(this);

                }
            } else if (status == 3) {
                if (this.status == 4 || this.status == 6) {
                    selectItem.push(this);
                    inMap(this);

                }
            } else if (status == 4) {
                if (this.status == 2 && formatDate4(this.end_date) < today) {
                    selectItem.push(this);
                    inMap(this);
                }
            }
        });
        if (status == 0) {
            if (items.length > 0) {
                showTable(items);
            }
        } else {
            if (selectItem.length > 0) {
                showTable(selectItem);
            }
        }


    }


    function showTable(items) {
        if (show) {
            var status = '';
            var str = '';
            str += '<table id="dt-table" class="table table-striped table-bordered table-hover dataTable no-footer" style="width: 100%;" role="grid" aria-describedby="dt-table_info">\n' +
                '    <thead>\n' +
                '    <tr role="row"><th style="width: 286px;" class="sorting_disabled" rowspan="1" colspan="1">项目名称</th><th style="width: 251px;" class="sorting_disabled" rowspan="1" colspan="1">项目承担单位</th><th style="width: 151px;" class="sorting_disabled" rowspan="1" colspan="1">项目监理单位</th><th style="width: 286px;" class="sorting_disabled" rowspan="1" colspan="1">项目起止时间</th><th style="width: 136px;" class="sorting_disabled" rowspan="1" colspan="1">项目状态</th><th style="width: 483px;" class="sorting_disabled" rowspan="1" colspan="1">操作</th></tr>\n' +
                '    </thead>\n' +
                '    <tbody>';
            $.each(items, function (i, item) {
                if (item.status == 2) {
                    status = "进行中";
                } else if (item.status == 3) {
                    status = "结题中";
                } else if (item.status == 4) {
                    status = "已结题";
                } else if (item.status == 5) {
                    status = "终止中";
                } else if (item.status == 6) {
                    status = "已终止";
                }
                str += '<tr role="row" class="odd"><td>' + item.name + '</td><td>' + item.responsible_unit + '</td><td>' + item.management_unit + '</td><td> ' + formatDate4(item.start_date) + '至' + formatDate4(item.end_date) + '</td><td>' + status + '</td><td>' +
                    '<button class="layui-btn layui-btn-xs" style="margin: 5px 10px 0 0;" onclick="showStage(' + item.id + ')"><i class="layui-icon">阶段总结</i></button>' +
                    '<button class="layui-btn layui-btn-xs" style="margin: 5px 10px 0 0;" onclick="showAudit(' + item.id + ')"><i class="layui-icon">查定报告</i></button>' +
                    '<button class="layui-btn layui-btn-xs" style="margin: 5px 10px 0 0;" onclick="showSkill(' + item.id + ')"><i class="layui-icon">技术总结</i></button>' +
                    '<button class="layui-btn layui-btn-xs" style="margin: 5px 10px 0 0;" onclick="showWork(' + item.id + ')"><i class="layui-icon">工作总结</i></button>' +
                    '<button class="layui-btn layui-btn-xs" style="margin: 5px 10px 0 0;" onclick="showTarget(' + item.id + ')"><i class="layui-icon">项目指标</i></button>' +
                    '<button class="layui-btn layui-btn-xs" style="margin: 5px 10px 0 0;" onclick="showFund(' + item.id + ')"><i class="layui-icon">经费使用</i></button>' +
                    '</td></tr><tr role="row" class="even">';
            });
            str += '</tbody>\n' +
                '</table>';

            var h1 = $(window).height() - 15;
            var w1 = $(window).width() - 30;
            var data = JSON.stringify(items);
            console.log(data);
            index = layer.open({
                title: "项目列表",
                type: 1,
                area: [w1 + 'px', h1 + 'px'],
                maxmin: true,
                shadeClose: true,
                content: str,
            });
            layui.element.init();
        }

    }

    function inMap(data) {
        var status = '';
        if (data['status'] == 2) {
            status = "进行中";
        } else if (data['status'] == 3) {
            status = "结题中";
        } else if (data['status'] == 4) {
            status = "已结题";
        } else if (data['status'] == 5) {
            status = "终止中";
        } else if (data['status'] == 6) {
            status = "已终止";
        }
        var content = "";
        content += '<div><span style="font-size: 18px;font-weight: bold;margin-right: 15px;">项目承担单位:</span><span>' + data['responsible_unit'] + '</span></div>';
        content += '<div><span style="font-size: 18px;font-weight: bold;margin-right: 15px;">项目监理单位:</span><span>' + data['management_unit'] + '</span></div>';
        content += '<div><span style="font-size: 18px;font-weight: bold;margin-right: 15px;">项目起止时间:</span><span>' + formatDate4(data['start_date']) + '---' + formatDate4(data['end_date']) + '</span></div>';
        content += '<div><span style="font-size: 18px;font-weight: bold;margin-right: 15px;">项目起止时间:</span><span>' + status + '</span></div>';
        content += '<button class="btn btn-primary" style="margin: 10px 20px 0 0;" onclick="showStage(' + data['id'] + ')">阶段总结</button>';
        content += '<button class="btn btn-primary" style="margin: 10px 20px 0 0;" onclick="showAudit(' + data['id'] + ')">查定报告</button>';
        content += '<button class="btn btn-primary" style="margin: 10px 20px 0 0;" onclick="showSkill(' + data['id'] + ')">技术总结</button>';
        content += '<button class="btn btn-primary" style="margin: 10px 20px 0 0;" onclick="showWork(' + data['id'] + ')">工作总结</button>';
        content += '<button class="btn btn-primary" style="margin: 10px 20px 0 0;" onclick="showTarget(' + data['id'] + ')">项目指标</button>';
        content += '<button class="btn btn-primary" style="margin: 10px 20px 0 0;" onclick="showFund(' + data['id'] + ')">经费使用</button>';
        var opts = {
            width: 500,
            height: 200,
            title: data['name'],
            enableMessage: true
        };
        /* color = null;*/
        /*if (data['type'] == 'EMPHASIS_RESEARCH_AND_DEVELOPM') {
            color = blueIcon;
        }
        if (data['type'] == 'ELECTRONIC_INFORMATION') {
            color = greenIcon;
        }*/
        var aa = signs.indexOf(data['type']);
        var color = diagrams[aa];
        addMarker(new BMap.Point(data['lng'], data['lat']), content, opts, color);
    }

    function hideTB111() {
        document.getElementById('allmap').className = 'col-md-9';
        document.getElementById('hide').style.display = 'none';
        document.getElementById('show').style.display = 'block';
    }

    function showTB() {

        //隐藏右侧图表，显示展示按钮
        document.getElementById('allmap').className = 'col-md-12';
        document.getElementById('show').style.display = 'none';
        document.getElementById('hide').style.display = 'block';
    }
</script>
</html>