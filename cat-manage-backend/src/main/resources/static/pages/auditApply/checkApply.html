<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" media="screen" href="../../layui/css/layui.css">
    <link rel="stylesheet" type="text/css" media="screen" href="../item/css/newProjecy.css">
    <style>
        .layui-table td {
            position: initial;
        }

        .layui-textarea {
            min-height: 60px;
        }
    </style>

</head>
<body>
<div class="layui-form" style="margin-top: 60px;">
    <table class="layui-table" lay-skin="nob" style="border-collapse: separate;">
        <colgroup>
            <col width="8%">
            <col width="3%">
            <col width="10%">
            <col width="28%">
            <col width="2%">
            <col width="10%">
            <col width="20">
            <col width="8%">
            <col width="3%">
            <col width="8%">
        </colgroup>
        <tbody>
        <tr style="height: 30px;">
            <td class="mainTd_0" rowspan="1" colspan="10"></td>
        </tr>
        <tr style="height: 22px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="8"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>
        <tr style="height: 33px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="2" colspan="2" style=""></td>
            <td class="mainTd_1" rowspan="1" colspan="4" style="text-align: center;">
                <div class="headline">
                    <span>科技计划项目查定申请书</span>
                </div>
            </td>
            <td class="mainTd_1" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="1"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>
        <tr style="height: 25px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="6"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>
        <tr style="height: 25px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="8" style="border-bottom: 1px solid #dadcde;"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>
        <tr style="height: 30px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="8"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>
        <!--基本信息-->
        <form id="form1">
            <tr style="height: 40px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="6" style="background: #f6f6f6 !important;">
                    <div class="subheading">
                        <span>丨 基本信息</span>
                    </div>
                </td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>
            <tr style="height: 24px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="8"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>
            <tr style="height: 40px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1">
                    <div class="field">
                        <span>合同编号</span>
                    </div>
                </td>
                <td class="mainTd_1 tdDorder" rowspan="1" colspan="1">
                    <div class="field">
                        <input type="hidden" name="id" id="item_id">
                        <input type="hidden" name="status" id="status">
                        <input type="text" name="contract_no">
                    </div>
                </td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1">
                    <div class="field">
                        <span>项目类别</span>
                    </div>
                </td>
                <td class="mainTd_1 tdDorder" rowspan="1" colspan="2">
                    <div class="field">
                        <input type="text" name="type">
                    </div>
                </td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>
            <tr style="height: 24px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="8"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>
            <tr style="height: 40px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1">
                    <div class="field">
                        <span>项目名称</span>
                    </div>
                </td>
                <td class="mainTd_1 tdDorder" rowspan="1" colspan="1">
                    <div class="field">
                        <input type="text" name="name">
                    </div>
                </td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1">
                    <div class="field">
                        <span>委托单位（甲方）</span>
                    </div>
                </td>
                <td class="mainTd_1 tdDorder" rowspan="1" colspan="2">
                    <div class="field">
                        <input type="text" name="entrusting_party">
                    </div>
                </td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>
            <tr style="height: 24px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="8"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>
            <tr style="height: 40px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1">
                    <div class="field">
                        <span>申报单位(乙方)</span>
                    </div>
                </td>
                <td class="mainTd_1 tdDorder" rowspan="1" colspan="1">
                    <div class="field">
                        <input type="text" name="responsible_unit" id="responsible_unit" readonly>
                    </div>
                </td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1">
                    <div class="field">
                        <span>单位地址</span>
                    </div>
                </td>
                <td class="mainTd_1 tdDorder" rowspan="1" colspan="2">
                    <div class="field">
                        <input type="text" name="address" id="address">
                    </div>
                </td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>
            <tr style="height: 24px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="8"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>
            <tr style="height: 40px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1">
                    <div class="field">
                        <span>项目负责人</span>
                    </div>
                </td>
                <td class="mainTd_1 tdDorder" rowspan="1" colspan="1">
                    <div class="field">
                        <input type="text" name="leaderName">
                    </div>
                </td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1">
                    <div class="field">
                        <span>联系电话</span>
                    </div>
                </td>
                <td class="mainTd_1 tdDorder" rowspan="1" colspan="2">
                    <div class="field">
                        <input type="text" name="leaderPhone">
                    </div>
                </td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>
        </form>
        </tbody>


        <tbody>
        <!--基本信息-->
        <form id="form2">
            <tr style="height: 22px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="8"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>
            <tr style="height: 40px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="6" style="background: #f6f6f6 !important;">
                    <div class="subheading">
                        <span>丨 指标查定详情</span>
                    </div>
                </td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>
            <tr style="height: 24px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="8"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>
            <tr style="height: 40px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1">
                    <div class="field">
                        <span>建议查定时间</span>
                    </div>
                </td>
                <td class="mainTd_1 tdDorder" rowspan="1" colspan="1">
                    <div class="field">

                        <p name="period" id="period"></p>
                    </div>
                </td>

            </tr>

            <tr style="height: 24px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="8"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>
            <tr style="height: 40px;">
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_1" rowspan="1" colspan="1">
                    <div class="field">
                        <span>申请说明</span>
                    </div>
                </td>
                <td class="mainTd_1 tdDorder" rowspan="1" colspan="5">
                    <div class="field">
                        <textarea name="content" id="content" placeholder="请输入内容" class="layui-textarea" readonly></textarea>
                    </div>
                </td>
                <td class="mainTd_1" rowspan="1" colspan="1"></td>
                <td class="mainTd_0" rowspan="1" colspan="1"></td>
            </tr>
        </form>
        <!--项目考核指标-->
        <tr style="height: 24px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="8"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>
        <tr style="height: 40px;">
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="1"></td>
            <td class="mainTd_1" rowspan="1" colspan="6">
                <div class="indicators">
                    <form>
                        <table class="layui-table">
                            <colgroup>
                                <col width="10%">
                                <col width="60%">
                                <col width="30%">
                            </colgroup>
                            <thead>
                            <tr style="background-color: #ffffff;">
                                <th class="tdDorder border-right-none" rowspan="1" colspan="3">
                                    <div class="field">
                                        <span id="target">查定指标</span>
                                    </div>
                                </th>
                            </tr>
                            <tr>
                                <th class="tdDorder">序号</th>
                                <th class="tdDorder">指标内容</th>
                                <th class="tdDorder">查定地址</th>
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </form>
                </div>
            </td>
            <td class="mainTd_1" rowspan="1" colspan="1"></td>
            <td class="mainTd_0" rowspan="1" colspan="1"></td>
        </tr>

        </tbody>
    </table>

</div>
<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" style="border: 0px;">
    <form class="form-horizontal" onsubmit="return false" id="form" style="padding-bottom: 30px;margin-top: 20px">


            <div class="layui-btn-group btn-group" style="text-align: center;display: none" >
                <button type="button" class="layui-btn layui-btn-sm" style="border-radius: 2px;"
                        id="test">
                    匹配专家
                </button>
                <button type="button" class="layui-btn layui-btn-sm" style="border-radius: 2px;"
                        onclick="pass();">
                    申请通过
                </button>

                <button type="button" class="layui-btn layui-btn-sm" style="border-radius: 2px;"
                        onclick="unPass();">
                    申请未通过
                </button>

            </div>

    </form>
</div>
</body>
<script src="../../js/constant.js"></script>
<script type="text/javascript" src="../../js/libs/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../../js/jq.js"></script>
<script type="text/javascript" src="../../js/plugin/bootstrapvalidator/bootstrapValidator.min.js"></script>
<script type="text/javascript" src="../../js/common.js"></script>
<script type="text/javascript" src="../../js/chooseArea.js"></script>
<script type="text/javascript" src="../../layui/layui.js"></script>
<script type="text/javascript" src='../list-layout/js/initSelectData.js'></script>
<script type="text/javascript" src='js/auditApply.js'></script>
<script type="text/javascript" src="../../js/matchExpert.js"></script>
<script type="text/javascript">
    var layedit, index;
    var arr = new Array();
    var id = getUrlParam("id");
    var item_id;
    var userType ;
    var match = false;
    var ids = new Array();
    var target_id;
    var start_date;
    var end_date;
    var content;
    layui.use(['layedit', 'upload', 'laydate', 'form', 'layer'], function () {
        layer = layui.layer;
        laydate = layui.laydate;
        upload = layui.upload;
        form = layui.form;
        var $ = layui.$, slider = layui.slider;


    });
    initData();
    $.matchExpert({
        elem: '#test',
        itemId: item_id,
        defaultSave: false,//自定义保存
        defaultSaveFun: function (arr) {
            if (arr.length == 0) {
                layer.msg("未选择专家！");
            } else {
                ids = arr;
                match = true;
            }
            console.log(arr);

        }
    });

    function initData() {
        var data = {
            id: id,
        }
        $.ajax({
            type: 'get',
            data: data,
            url: domainName + '/project-item/item/target/applyList',
            async: false,
            success: function (data) {
                $(data).each(function () {
                    status(data[0].status);
                    item_id = data[0].item_id;
                    queryInformation(data[0].item_id);
                    queryContactWay(data[0].item_id);
                    $("#content").text(data[0].content);
                    content = data[0].content;
                    $("#period").text(formatDate3(data[0].start_date) + " - " + formatDate3(data[0].end_date));
                    end_date = data[0].end_date;
                    start_date = data[0].start_date;
                    target_id=data[0].target_id;
                    $.get(domainName + "/project-item/item/indicators/ids", {ids: data[0].target_id}, function (data1) {
                        $.each(data1, function (i, item) {
                            var serial = $("#target").parents('thead').next().children().length + 1;
                            var str = '';
                            var text = getsuperior(item.site);
                            str = '<tr>' +
                                '<td class="mainTd_1 tdDorder">' + serial + '<input type="hidden" name="type" value="' + item.type + '"></td>' +
                                '<td class="mainTd_1 tdDorder" rowspan="1" colspan="1">' +
                                '<div class="field">' +
                                '<span type="text"  name="content" lay-verify="required"> ' + item.content + ' </span>' +
                                '</div>' +
                                '</td>' +
                                '<td class="mainTd_1 tdDorder" rowspan="1" colspan="1">' +
                                '<div class="field" style="position: relative;">' +
                                '<span type="text" name="site">' + text + '</span>' +
                                '</div>' +
                                '</td>' +
                                '</tr>';
                            $("#target").parents('thead').next().append(str);
                        });
                    })

                });

            }
        });
    }





    function status(status) {
        $.ajax({
            type: 'get',
            url : domainName + '/api-c/company/now-user',
            async: false,
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                var identity = data.identity;
                if (identity=="PARTY_C" && status == 1){
                    var obj = document.getElementsByClassName("btn-group");
                    obj[0].style.display = "block";
                }

            }
        });

    }

    function pass() {
        if (match){
            $.ajax({
                type: 'put',
                url: domainName + '/project-item/item/target/auditApply/update',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({id: id, status: 3}),
                success: function (data) {
                    for (var i =0;i<ids.length;i++){
                        var expert_id = ids[i].userId;
                        var result = {"item_id": item_id, "audit_apply_id": id,"expert_id":expert_id,"target_id":target_id,"end_date":end_date,"start_date":start_date,"content":content};
                        $.ajax({
                            type: 'post',
                            url: domainName + '/project-item/item/target/auditApplyResult/one',
                            contentType: "application/json; charset=utf-8",
                            data: JSON.stringify(result),
                            success: function (data) {
                            }
                        });
                    }
                    var msg = "成功";
                    layer.msg(msg, function () {
                        //将专家与查定申请关联

                        parent.location.reload();
                    });
                }
            });
        }else {
            var msg = "请指定专家对指标进行查定！";
            layer.msg(msg, {shift: -1, time: 1000});
        }

    }

    function unPass() {
        $.ajax({
            type: 'put',
            url: domainName + '/project-item/item/target/auditApply/update',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({id: id, status: 2}),
            success: function (data) {
                var msg = "成功";
                layer.msg(msg, {shift: -1, time: 1000}, function () {
                    parent.location.reload();
                });
            }
        });
    }

</script>
</body>
</html>