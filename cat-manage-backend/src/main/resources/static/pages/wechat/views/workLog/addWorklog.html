<!DOCTYPE html>
<html>
<head>
    <title>工作日志起草</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
">

    <link rel="stylesheet" href="../../weui/lib/weui.min.css">
    <link rel="stylesheet" href="../../weui/css/jquery-weui.css">
    <link rel="stylesheet" href="../../weui/css/demos.css">
    <link rel="stylesheet" href="../../css/common.css">
</head>

<body ontouchstart>
<form class="form-horizontal" onsubmit="return false" id="form">
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <label class="weui-label">当前进度</label>
        </div>
    </div>
    <div class="weui-slider-box" id='slider2'>
        <div class="weui-slider">
            <div id="sliderInner" class="weui-slider__inner">
                <div id="sliderTrack" class="weui-slider__track"></div>
                <div id="sliderHandler"  class="weui-slider__handler"></div>
            </div>
        </div>
        <div id="sliderValue" class="weui-slider-box__value" style="margin-right: 10px;"></div>
    </div>
    <div class="weui-line" style="margin-top: 15px;"></div>
    <div class="weui-cells__title">进度描述</div>
    <div class="weui-cells weui-cells_form">
        <div class="weui-cell">
            <div class="weui-cell__bd">
                <textarea class="weui-textarea" placeholder="请输入文本" id="content" name="content" rows="10"></textarea>
            </div>
        </div>
    </div>
    <div class="weui-line"></div>
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <div class="weui-uploader">
                <div class="weui-uploader__hd">
                    <p class="weui-uploader__title" style="font-weight: bold">图片上传</p>
                    <div class="weui-uploader__info">0/6</div>
                </div>
                <div class="weui-uploader__bd">
                    <ul class="weui-uploader__files">
                    </ul>
                    <div class="weui-uploader__input-box">
                        <input class="weui-uploader__input" type="file" accept="image/*"
                               multiple="" onchange="uploader(this)" data-sum="6">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="weui-line"></div>
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <div class="weui-uploader">
                <div class="weui-uploader__hd">
                    <p class="weui-uploader__title" style="font-weight: bold">视频上传</p>
                    <div class="weui-uploader__info">0/6</div>
                </div>
                <div class="weui-uploader__bd">
                    <ul class="weui-uploader__files">
                    </ul>
                    <div class="weui-uploader__input-box">
                        <input class="weui-uploader__input" type="file" accept="video/mp4"
                               multiple="" onchange="uploader(this)" data-sum="6">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="weui-line"></div>
    <div class="weui-cell">
        <div class="weui-cell__bd">
            <div class="weui-uploader">
                <div class="weui-uploader__hd">
                    <p class="weui-uploader__title" style="font-weight: bold">文件上传</p>
                    <div class="weui-uploader__info">0/6</div>
                </div>
                <div class="weui-uploader__bd">
                    <ul class="weui-uploader__files">
                    </ul>
                    <div class="weui-uploader__input-box">
                        <input class="weui-uploader__input" type="file"
                               accept="application/*" multiple="" onchange="uploader(this)" data-sum="6">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" name="accessory" id="accessory" >
    <input type="hidden" name="plan" id="plan" value="">
    <div class="weui-line"></div>
    <div class="weui-btn-area">
        <a class="weui-btn weui-btn_primary" href="javascript:" onclick="save(this)">提交</a>
    </div>
</form>

<script type="text/javascript" src="../../../../js/libs/jquery-3.3.1.min.js"></script>
<script src="../../weui/lib/fastclick.js"></script>
<script src="../../weui/js/jquery-weui.js"></script>
<script src="../../../../js/constant.js"></script>
<script type="text/javascript" src="../../../../js/jq.js"></script>
<script type="text/javascript" src="../../../../js/common.js"></script>

<script>

    function uploader(obj) {
        if ($(obj).val() == "") {
            $.toast("请选择上传的目标文件!", "forbidden");
            return false;
        }
        var size1 = $(obj)[0].files[0].size;
        if (size1 > 104857600) {
            $.toast("上传文件不能大于100M!", "forbidden");
            return false;
        }
        var div = $(obj).parents('div[class=weui-uploader__bd]');
        var formData = new FormData();
        formData.append("file", $(obj)[0].files[0]);
        $.ajax({
            type: "post",
            url: domainName + '/zuul/api-f/files',
            data: formData,
            processData: false,
            contentType: false,
            success: function (res) {
                $.toast('上传成功');
                var type = res.contentType;
                if (res.isImg) {
                    $(div).find('ul').append('<li class="weui-uploader__file" style="background-image:url(' + res.url + ')"></li>');
                }
                if (type.substring(0, 11) == 'application') {
                    $(div).find('ul').append('<li class="weui-uploader__file" style="background-image:url(../../images/pic_160.png);">' + res.name + '</li>');
                }
                if (type.substring(0, 5) == 'video') {
                    $(div).find('ul').append('<li class="weui-uploader__file" style="background-image:url(../../images/pic_160.png)">' +
                        '<video class="weui-uploader__file" controls  src="' + res.url + '">' + res.name + '</video></li>');
                }
                var sum = $(obj).attr('data-sum');
                var li = $(div).find('li[class=weui-uploader__file]');
                if (li.length >= sum) {
                    $($(obj).parents('div[class=weui-uploader__input-box]')).remove();
                }
                var accessory = $('#accessory').val();
                if (jQuery.isEmptyObject(accessory)) {
                    $('#accessory').val(res.id);
                } else {
                    $('#accessory').val(accessory+ ',' + res.id);
                }
            },
            error: function (xhr, textStatus, errorThrown) {
                $.toast('上传失败', 'forbidden');
            }
        });
    }

    $(function () {
        FastClick.attach(document.body);
    });
    var plan = 0;
    $.get(domainName + "/api-summary/work-log/lately", {itemId: 1, targetId: 1}, function (res) {
        if (!jQuery.isEmptyObject(res.plan)) {
            plan = parseInt(res.plan);
        }
        setPlan(plan);
    });
    $('#slider2').slider(function (per) {
       if(per<plan){
           setPlan(plan);
       }else {
           $("#plan").val(per);
       }
    });
    function setPlan(plan) {
        $("#sliderTrack").css('min-width',plan + '%');
        $("#sliderHandler").css('left',plan + '%');
        $("#sliderValue").html(plan + '%');
        $("#plan").val(plan + '%')
    }

    function save(obj) {
        $(obj).attr("disabled", true);
        var formdata = $("#form").serializeObject();
        formdata.itemId = 44;
        formdata.targetId = 492;
        $.ajax({
            type: 'post',
            url: domainName + '/api-summary/work-log',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(formdata),
            success: function (data) {
                var msg = "成功";
                layer.msg(msg, {shift: -1, time: 1000}, function () {
                    $(obj).attr("disabled", false);
                });
            }
        });
    }

</script>
</body>
</html>
