<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>资金使用明细</title>
    <link rel="stylesheet" type="text/css" media="screen" href="../../../../css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="../../../../layui/css/layui.css">
    <link rel="stylesheet" type="text/css" media="screen" href="css/details.css">
    <style>
        .table-info {
            background-color: #4FAAA2;
            border-color: #4FAAA2;
            margin: 40px;
            color: white;
            font-size: 18px;
            font-weight: bolder;
            text-align: center;
        }
    </style>
</head>
<body>
<div  style="margin:10px 0 10px 90% ">
    <button class="layui-btn layui-btn-sm" onclick="location.href='../../list.html'">
        <i class="layui-icon">&#xe65c;</i> 返回列表
    </button>
</div>

<div class="content">
    <div class="module">
        <form class="layui-form">
            <table class="layui-table">
                <colgroup>
                    <col width="3%">
                    <col width="27%">
                    <col width="20%">
                    <col width="20%">
                    <col width="20%">
                    <col width="10%">
                </colgroup>
                <thead>
                <tr>
                    <th class="table-info" style="border-bottom-color: #4FAAA2"></th>
                    <th>科目</th>
                    <th>经费来源</th>
                    <th>原有金额（万元）</th>
                    <th>剩余金额（万元）</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="expenditure">
                <tr>
                    <td rowspan="14" class="table-info">经费使用明细</td>
                    <td colspan="5">（一）直接费用</td>
                </tr>
                <tr>
                    <td colspan="5" id="indirect">（二）间接费用</td>
                </tr>
                <tr>
                    <td colspan="2">合计</td>
                    <td id="total"></td>
                    <td id="surplus"></td>
                </tr>
                </tbody>
            </table>
        </form>
    </div>
</div>
</body>
<script type="text/javascript" src='../../../../js/constant.js'></script>
<script type="text/javascript" src="../../../../js/libs/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../../../../js/jq.js"></script>
<script type="text/javascript" src="../../../../layui/layui.js"></script>
<script type="application/javascript" src="../../../../layui/xm-select.js"></script>
<script type="text/javascript" src='../../../../js/common.js'></script>
<script type="text/javascript" src='../../js/serializeJson.js'></script>
<script type="text/javascript" src='../../js/initSelectData.js'></script>
<script type="text/javascript" src='../../js/saveData.js'></script>
<script type="text/javascript" src='../../js/addTable.js'></script>
<script type="text/javascript" src="../../js/projecDetailst.js"></script>
<script type="text/javascript" src='../../js/updateProject.js'></script>
<script>
    layui.use(['layer', 'laydate', 'upload'], function () {
        var layer = layui.layer
            , upload = layui.upload
            , laydate = layui.laydate;

        lay('.date').each(function () {
            laydate.render({
                elem: this
                , format: 'yyyy年MM月dd日'
                , trigger: 'click'
            });
        });
    })

    //获取项目数据项目
    var id = getUrlParam("id");
    getFund(id);

    function addUseFund(fundId) {
        layer.open({
            title: "资金使用录入",
            type: 2,
            area: ['1000px', '600px'],
            maxmin: true,
            shadeClose: true,
            content: ['html/add_usefund.html?itemId=' + id + '&id=' + fundId],
            end: function () {
                window.location.reload();
            }
        });
    }

    function particulars(id) {
        layer.open({
            title: "资金使用明细",
            type: 2,
            area: ['1000px', '600px'],
            maxmin: true,
            shadeClose: true,
            content: ['html/particulars.html?id=' + id]
        });
    }

    function getFund(id) {
        $.ajax({
            type: 'get',
            url: domainName + '/project-item/item/fund/list',
            data: "item_id=" + id,
            async: false,
            success: function (data) {
                var total = 0,
                    surplus = 0;
                $(data).each(function () {
                    total += this.money;
                    surplus += gatFundUse(this.id,this.money);

                    var subject = analysisLableContent(this.subject);
                    var source = analysisLableContent(this.source);

                    var str1 = '<td>'+source+'</td><td>'+this.money+'</td><td>'+gatFundUse(this.id,this.money)+'</td>' +
                        '<td><button type="button" class="layui-btn layui-btn-xs" onclick="addUseFund(' + this.id + ');">录入</button>\n' +
                        '    <button type="button" class="layui-btn layui-btn-xs" onclick="particulars(' + this.id + ');">明细</button></td></tr>',
                        str = '';
                    $('#expenditure').children().first().children().first().attr('rowspan', $('#expenditure').children().length + 1);
                    var arr = $('#expenditure').find('input[name=subject][value=' +this.subject + ']');
                    if(arr.length==0){
                        str = '<tr><td>'+subject+'<input type="hidden" name="subject" value="'+this.subject+'"></td>'+str1;
                        if(this.type==0){
                            $('#indirect').parent().before(str);
                        }else {
                            $('#total').parent().before(str);
                        }
                    }else {
                        str = '<tr>'+str1;
                        arr.last().parent().parent().after(str);
                        arr.first().parent().parent().children().eq(0).attr('rowspan', arr.length + 1);
                    }
                });
                $("#total").text(total);
                $("#surplus").text(surplus);
            }
        });
    }
    function gatFundUse(id,original) {
        var surplus = 0;
        $.ajax({
            type: 'get',
            url: domainName + '/project-item/item/fund/use/list',
            data: "fund_id=" + id,
            async: false,
            success: function (data) {
                var count=0;
                $(data).each(function () {
                    count +=this.money;
                })
                surplus = original-count;
            }
        })
        return surplus;
    }
</script>
</html>